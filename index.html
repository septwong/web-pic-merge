<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¡ç‰‡ç”Ÿæˆå™¨</title>
    <!-- ä½¿ç”¨SVGä½œä¸ºç°ä»£æµè§ˆå™¨çš„favicon -->
    <link rel="icon" href="favicon.svg" type="image/svg+xml" />
    <!-- ä¸ºäº†å…¼å®¹æ—§æµè§ˆå™¨ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å·¥å…·å°†SVGè½¬æ¢ä¸ºICOæˆ–PNG: https://convertio.co/svg-ico/ -->
    <link rel="shortcut icon" href="favicon.svg" type="image/svg+xml" />
    <!-- å¦‚éœ€æ›´å¥½çš„å…¼å®¹æ€§ï¼Œå»ºè®®æ·»åŠ ä»¥ä¸‹å‡ ç§å°ºå¯¸çš„å›¾æ ‡ï¼š
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    -->
    <style>
      :root {
        --primary-color: #07c160; /* å¾®ä¿¡ç»¿ */
        --secondary-color: #10aeff; /* å¾®ä¿¡è“ */
        --light-color: #f8f9fa;
        --dark-color: #343a40;
        --success-color: #07c160; /* å¾®ä¿¡ç»¿ */
        --danger-color: #fa5151; /* å¾®ä¿¡çº¢ */
        --warning-color: #ff9f0f; /* å¾®ä¿¡æ©™ */
        --bg-color1: #d9f7be; /* æµ…ç»¿æ¸å˜ */
        --bg-color2: #b5f5ec; /* æµ…è“æ¸å˜ */
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        font-family: "Helvetica Neue", Arial, sans-serif;
        line-height: 1.6;
        color: #333;
        background-color: #f5f5f5;
        margin: 0;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background-color: #fff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      }

      h1 {
        text-align: center;
        margin-bottom: 30px;
        color: #333;
      }
      .title {
        display: flex;
        justify-content: center;
        align-items: center;
      }

      /* ä¸¤åˆ—å¸ƒå±€æ ·å¼ */
      .main-content {
        display: flex;
        flex-direction: row;
        gap: 30px;
        margin-bottom: 20px;
      }

      .settings-column {
        flex: 0 0 40%;
        max-width: 40%;
      }

      .preview-column {
        flex: 0 0 60%;
        max-width: 60%;
        position: sticky;
        top: 20px;
        align-self: flex-start;
      }

      /* é¢æ¿æ ·å¼è°ƒæ•´ */
      .panels {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      /* ä¸»åŠŸèƒ½Tabsæ ·å¼ */
      .main-tabs {
        display: flex;
        gap: 0;
        border-bottom: 3px solid #e0e0e0;
        margin-bottom: 30px;
      }

      .main-tab-btn {
        flex: 1;
        padding: 16px 20px;
        background: none;
        border: none;
        font-size: 16px;
        font-weight: 600;
        color: #666;
        cursor: pointer;
        position: relative;
        transition: all 0.3s ease;
        border-bottom: 3px solid transparent;
        margin-bottom: -3px;
      }

      .main-tab-btn:hover {
        color: var(--primary-color);
        background-color: rgba(74, 144, 226, 0.05);
      }

      .main-tab-btn.active {
        color: var(--primary-color);
        border-bottom-color: var(--primary-color);
        background-color: rgba(74, 144, 226, 0.08);
      }

      /* ä¸»Tabå†…å®¹åŒºåŸŸ */
      .main-tab-content {
        display: none;
      }

      .main-tab-content.active {
        display: block;
      }

      .panel {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        padding: 20px;
        margin-bottom: 0;
      }

      .panels {
        display: flex;
        flex-direction: column;
        gap: 20px;
        width: 100%;
      }

      .panel {
        width: 100%;
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
      }

      .panel-title {
        font-size: 1.2rem;
        margin-bottom: 15px;
        color: var(--primary-color);
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 5px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
      }

      input[type="text"],
      input[type="file"],
      select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
      }

      input[type="color"] {
        width: 50px;
        height: 30px;
        padding: 2px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .color-picker {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .color-picker input[type="range"] {
        flex: 1;
        min-width: 100px;
      }

      .slider-container {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .slider-value {
        min-width: 30px;
        text-align: center;
      }

      input[type="range"] {
        flex: 1;
      }

      .btn {
        display: inline-block;
        padding: 10px 20px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        transition: background-color 0.3s;
      }

      .btn:hover {
        background-color: var(--secondary-color);
      }

      .btn-danger {
        background-color: var(--danger-color);
      }

      .btn-danger:hover {
        background-color: #c82333;
      }

      .btn-group {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-bottom: 20px;
      }

      .preview-container {
        text-align: center;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        padding: 20px;
        position: sticky;
        top: 20px;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .preview-title {
        margin-bottom: 20px;
        font-weight: 500;
        font-size: 1.2rem;
        color: var(--primary-color);
      }

      #cardPreview {
        max-width: 100%;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        display: none;
        margin-bottom: 20px;
      }

      .card-preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        width: 100%;
        margin-bottom: 20px;
      }

      .preview-item {
        position: relative;
      }

      .preview-item img {
        width: 100%;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        cursor: pointer; /* æ·»åŠ æ‰‹å‹å…‰æ ‡ */
      }

      /* æ¨¡æ€æ¡†æ ·å¼ */
      .modal {
        display: none;
        position: fixed;
        z-index: 1001;
        padding-top: 60px;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.9);
      }

      .modal-content {
        margin: auto;
        display: block;
        max-width: 90%;
        max-height: 85vh; /* é™åˆ¶æœ€å¤§é«˜åº¦ä¸ºè§†çª—é«˜åº¦çš„85% */
      }

      .close-btn {
        position: absolute;
        top: 15px;
        right: 35px;
        color: #f1f1f1;
        font-size: 40px;
        font-weight: bold;
        transition: 0.3s;
        cursor: pointer;
      }

      .close-btn:hover,
      .close-btn:focus {
        color: #bbb;
        text-decoration: none;
        cursor: pointer;
      }

      /* é¢„è§ˆå¡ç‰‡åº•éƒ¨æ“ä½œæŒ‰é’®å®¹å™¨ï¼ˆé€šè¿‡æŒ‰é’®è‡ªèº«å®šä½æ¨¡æ‹Ÿï¼‰ */
      .preview-item .download-btn {
        position: absolute;
        bottom: 10px;
        padding: 6px 12px;
        font-size: 12px;
        line-height: 1;
        background: rgba(0, 0, 0, 0.65);
        color: #fff;
        border: none;
        border-radius: 999px; /* èƒ¶å›ŠæŒ‰é’® */
        cursor: pointer;
        opacity: 1;
        backdrop-filter: blur(6px);
        transition: background 0.2s ease;
      }

      /* ä¸‹è½½æŒ‰é’®å’Œå¤åˆ¶æŒ‰é’®ä½ç½®ï¼ˆå³ä¸‹è§’å¯¹é½ï¼Œåƒç³»ç»Ÿç»„ä»¶ï¼‰ */
      .preview-item .download-btn:first-of-type {
        right: 64px;
        left: auto;
        transform: none;
      }

      .preview-item .download-btn:last-of-type {
        right: 12px;
        left: auto;
        transform: none;
      }

      /* é¢„è§ˆåŒºåŸŸçš„æŒ‰é’®ç»„ */
      .preview-btn-group {
        display: flex;
        gap: 15px;
        margin-top: 20px;
        justify-content: center;
      }

      /* æ°´å°æ ·å¼ */
      .watermark-container {
        margin-top: 15px;
      }

      .watermark-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .watermark-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .iphone-color-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      /* Tab æ ·å¼ */
      .settings-tabs {
        display: flex;
        gap: 0;
        border-bottom: 2px solid #e0e0e0;
        margin-bottom: 20px;
      }

      .tab-btn {
        padding: 12px 20px;
        background: none;
        border: none;
        font-size: 14px;
        font-weight: 500;
        color: #666;
        cursor: pointer;
        position: relative;
        transition: all 0.3s ease;
        white-space: nowrap;
      }

      .tab-btn:hover {
        color: var(--primary-color);
        background-color: rgba(74, 144, 226, 0.05);
      }

      .tab-btn.active {
        color: var(--primary-color);
        font-weight: 600;
      }

      .tab-btn.active::after {
        content: "";
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 2px;
        background-color: var(--primary-color);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(255, 255, 255, 0.9);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        text-align: center;
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .loading.show {
        opacity: 1;
        display: block;
      }

      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top: 4px solid var(--primary-color);
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .toast {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 24px;
        border-radius: 4px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
      }

      .toast.show {
        opacity: 1;
      }

      .toast-success {
        background-color: #d4edda;
        color: #155724;
        border-left: 4px solid #28a745;
        font-weight: 500;
      }

      .toast-error {
        background-color: #f8d7da;
        color: #721c24;
        border-left: 4px solid #dc3545;
        font-weight: 500;
      }

      .image-preview-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
      }

      .image-preview {
        max-width: 100%;
        max-height: 150px;
        display: block;
        border-radius: 4px;
      }

      .preview-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
      }

      .card-preview-item {
        position: relative;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        padding: 8px;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
      }

      .card-preview-item:hover {
        border-color: #4a90e2;
        box-shadow: 0 4px 12px rgba(74, 144, 226, 0.15);
        transform: translateY(-2px);
      }

      .card-btn-group {
        display: flex;
        gap: 5px;
        position: absolute;
        bottom: 5px;
        right: 5px;
      }

      .card-image {
        max-width: 100%;
        max-height: 300px;
        display: block;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .border-preview-container {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        background-color: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        margin-top: 10px;
      }

      #iphoneBorderImage {
        max-width: 100%;
        max-height: 200px;
        object-fit: contain;
        border-radius: 4px;
        cursor: pointer;
        transition: transform 0.3s ease;
      }

      #iphoneBorderImage:hover {
        transform: scale(1.05);
      }

      .border-info {
        font-size: 14px;
        color: #666;
        margin-top: 10px;
        margin-bottom: 0;
      }

      .bg-type-btn-group {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }

      .bg-type-btn {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 8px 16px;
        background: #f8f9fa;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 14px;
        font-weight: 500;
        color: #666;
        gap: 6px;
      }

      .bg-type-btn:hover {
        background: #f0f2f5;
        border-color: #4a90e2;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(74, 144, 226, 0.15);
      }

      .bg-type-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-color: #667eea;
        color: white;
        box-shadow: 0 2px 10px rgba(102, 126, 234, 0.4);
      }

      .btn-icon {
        font-size: 18px;
      }

      .bg-settings {
        margin-top: 15px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
      }

      #iphoneBgGradientPreset {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .btn-small {
        padding: 4px 8px;
        font-size: 12px;
      }

      .btn-primary {
        background-color: var(--primary-color);
      }

      .btn-secondary {
        background-color: #6c757d;
      }

      .font-option {
        padding: 5px;
        font-family: inherit;
      }

      .font-arial {
        font-family: Arial, sans-serif;
      }
      .font-times {
        font-family: "Times New Roman", serif;
      }
      .font-courier {
        font-family: "Courier New", monospace;
      }
      .font-georgia {
        font-family: Georgia, serif;
      }
      .font-verdana {
        font-family: Verdana, sans-serif;
      }
      .font-palatino {
        font-family: "Palatino Linotype", "Book Antiqua", serif;
      }

      @media (max-width: 1024px) {
        .main-content {
          flex-direction: column;
        }

        .settings-column,
        .preview-column {
          flex: 0 0 100%;
          max-width: 100%;
        }

        .preview-column {
          position: static;
        }
        /* å¤åˆ¶æŒ‰é’®ï¼šä¸»æ“ä½œï¼Œè§†è§‰æ›´çªå‡º */
        .preview-item .download-btn:last-of-type {
          background: rgba(0, 0, 0, 0.8);
          font-weight: 600;
        }
        /* ä¸‹è½½æŒ‰é’®ï¼šæ¬¡æ“ä½œï¼Œå¼±åŒ–ä¸€ç‚¹ */
        .preview-item .download-btn:first-of-type {
          background: rgba(0, 0, 0, 0.45);
        }
        /* hover åé¦ˆä¾ç„¶ä¿ç•™ */
        .preview-item .download-btn:hover {
          background: rgba(0, 0, 0, 0.9);
          transform: translateY(-2px);
        }
      }

      /* H5 æ‰‹æœºç«¯é€‚é… */
      @media (max-width: 768px) {
        .container {
          padding: 15px;
          margin: 10px;
          border-radius: 8px;
        }

        h1 {
          font-size: 1.5rem;
          margin-bottom: 20px;
        }

        .title img {
          height: 28px !important;
        }

        .main-content {
          gap: 20px;
        }

        .panel {
          padding: 15px;
        }

        .panel-title {
          font-size: 1rem;
          margin-bottom: 12px;
        }

        /* Tab æ é€‚é… */
        .settings-tabs {
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
          padding-bottom: 5px;
        }

        .tab-btn {
          padding: 10px 15px;
          font-size: 13px;
          white-space: nowrap;
        }

        /* è¡¨å•å…ƒç´ é€‚é… */
        .form-group {
          margin-bottom: 12px;
        }

        label {
          font-size: 14px;
          margin-bottom: 4px;
        }

        input[type="text"],
        input[type="file"],
        select {
          padding: 8px;
          font-size: 14px;
        }

        input[type="color"] {
          width: 40px;
          height: 28px;
        }

        .slider-container {
          gap: 8px;
        }

        .slider-value {
          min-width: 25px;
          font-size: 13px;
        }

        input[type="range"] {
          height: 4px;
        }

        .btn {
          padding: 8px 16px;
          font-size: 14px;
        }

        /* é¢„è§ˆåŒºåŸŸé€‚é… */
        .preview-container {
          padding: 15px;
        }

        .preview-title {
          font-size: 1rem;
          margin-bottom: 15px;
        }

        .card-preview-grid {
          gap: 15px;
        }

        .preview-item {
          max-width: 100%;
        }

        .preview-item img {
          max-width: 100%;
          height: auto;
        }

        .preview-item .download-btn {
          padding: 8px 14px;
          font-size: 13px;
        }

        /* é¢„è§ˆæŒ‰é’®ç»„ */
        .preview-btn-group {
          flex-direction: column;
          gap: 10px;
        }

        .preview-btn-group .btn {
          width: 100%;
        }

        /* å›¾ç‰‡é¢„è§ˆå®¹å™¨ */
        .image-preview-container {
          gap: 8px;
        }

        .image-preview {
          width: 60px;
          height: 60px;
        }

        /* Toast æç¤º */
        .toast {
          max-width: 80%;
          padding: 12px 20px;
          font-size: 14px;
        }

        /* Modal */
        .modal-content {
          max-width: 95%;
          max-height: 85vh;
        }

        .close-btn {
          top: 10px;
          right: 20px;
          font-size: 30px;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
          padding: 15px;
          width: 80%;
          max-width: 200px;
        }

        .spinner {
          width: 30px;
          height: 30px;
          border-width: 3px;
        }

        /* æ°´å°ç»„å’Œ iPhone é¢œè‰²ç»„ */
        .watermark-group,
        .iphone-color-group {
          gap: 10px;
        }
      }

      /* æ›´å°å±å¹•é€‚é… */
      @media (max-width: 480px) {
        .container {
          padding: 10px;
          margin: 5px;
        }

        h1 {
          font-size: 1.3rem;
        }

        .title img {
          height: 24px !important;
        }

        .panel {
          padding: 12px;
        }

        .tab-btn {
          padding: 8px 12px;
          font-size: 12px;
        }

        .panel-title {
          font-size: 0.95rem;
        }

        .card-preview-grid {
          grid-template-columns: 1fr !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="title">
        <img
          src="logo.svg"
          alt="ç½‘ç«™Logo"
          style="height: 36px; vertical-align: middle; margin-right: 10px"
        />å¡ç‰‡ç”Ÿæˆå™¨
      </h1>

      <!-- ä¸»è¦åŠŸèƒ½Tabs -->
      <div class="main-tabs">
        <button class="main-tab-btn active" data-main-tab="card">å¡ç‰‡ç”Ÿæˆ</button>
        <button class="main-tab-btn" data-main-tab="iphone">iPhoneå¥—å£³</button>
      </div>

      <!-- å¡ç‰‡ç”ŸæˆTabå†…å®¹ -->
      <div class="main-tab-content active" id="main-tab-card">
        <div class="main-content">
        <!-- å·¦ä¾§è®¾ç½®åŒºåŸŸ -->
        <div class="settings-column">
          <div class="panels">
            <div class="panel">
              <h2 class="panel-title">ä¸Šä¼ å›¾ç‰‡</h2>

              <div class="form-group">
                <label for="mainImageUpload">ä¸Šä¼ å¤šå¼ ä¸»å›¾ç‰‡</label>
                <input
                  type="file"
                  id="mainImageUpload"
                  accept="image/*"
                  multiple
                />
                <div
                  id="mainImagePreviewContainer"
                  class="image-preview-container"
                ></div>
              </div>
              <div class="form-group">
                <label for="qrCodeImageUpload">ä¸Šä¼ å¤šä¸ªäºŒç»´ç </label>
                <input
                  type="file"
                  id="qrCodeImageUpload"
                  accept="image/*"
                  multiple
                />
                <div
                  id="qrCodeImagePreviewContainer"
                  class="image-preview-container"
                ></div>
              </div>
            </div>

            <!-- è®¾ç½®é¢æ¿ - ä½¿ç”¨ Tab åˆ‡æ¢ -->
            <div class="panel">
              <h2 class="panel-title">æ ·å¼è®¾ç½®</h2>

              <!-- Tab å¯¼èˆª -->
              <div class="settings-tabs">
                <button class="tab-btn active" data-tab="style">æ ·å¼</button>
                <button class="tab-btn" data-tab="text">æ–‡å­—</button>
                <button class="tab-btn" data-tab="watermark">æ°´å°</button>
              </div>

              <!-- æ ·å¼è®¾ç½® Tab -->
              <div class="tab-content active" id="tab-style">
                <div class="form-group">
                  <label for="stylePreset">å¾®ä¿¡æ ·å¼é¢„è®¾</label>
                  <select id="stylePreset">
                    <option value="random" selected>éšæœº(ç”Ÿæˆç¾è§‚æ¸å˜)</option>
                    <option value="auto">è‡ªåŠ¨(æå–å›¾ç‰‡æœ€é²œè‰³é¢œè‰²)</option>
                    <option value="default">é»˜è®¤æ ·å¼</option>
                    <option value="wechat-blue">å¾®ä¿¡è“</option>
                    <option value="wechat-green">å¾®ä¿¡ç»¿</option>
                    <option value="elegant">ç®€çº¦é£æ ¼</option>
                    <option value="warm">æš–è‰²è°ƒ</option>
                    <option value="cool">å†·è‰²è°ƒ</option>
                    <option value="custom">è‡ªå®šä¹‰</option>
                  </select>
                </div>

                <div class="form-group">
                  <button id="randomGradientBtn" class="btn">éšæœºæ¸å˜</button>
                </div>

                <div class="form-group">
                  <label for="bgColor1">èƒŒæ™¯é¢œè‰² 1</label>
                  <div class="color-picker">
                    <input type="color" id="bgColor1" value="#D5E7FB" />
                    <span id="bgColor1Value">#D5E7FB</span>
                  </div>
                </div>

                <div class="form-group">
                  <label for="bgColor2">èƒŒæ™¯é¢œè‰² 2</label>
                  <div class="color-picker">
                    <input type="color" id="bgColor2" value="#9EBEFA" />
                    <span id="bgColor2Value">#9EBEFA</span>
                  </div>
                </div>

                <div class="form-group">
                  <label for="gradientType">æ¸å˜æ–¹å‘</label>
                  <select id="gradientType">
                    <option value="to right">æ°´å¹³</option>
                    <option value="to bottom">å‚ç›´</option>
                    <option value="to right bottom">å¯¹è§’çº¿</option>
                    <option value="circle">å¾„å‘</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="cardPadding">å†…è¾¹è·</label>
                  <div class="slider-container">
                    <input type="range" id="cardPadding" min="0" max="50" value="0" />
                    <span class="slider-value" id="cardPaddingValue">0</span>
                  </div>
                </div>

                <div class="form-group">
                  <label for="cardRadius">åœ†è§’åŠå¾„</label>
                  <div class="slider-container">
                    <input type="range" id="cardRadius" min="0" max="50" value="0" />
                    <span class="slider-value" id="cardRadiusValue">0</span>
                  </div>
                </div>

                <div class="form-group">
                  <label for="cardShadow">é˜´å½±å¼ºåº¦</label>
                  <div class="slider-container">
                    <input type="range" id="cardShadow" min="0" max="20" value="5" />
                    <span class="slider-value" id="cardShadowValue">5</span>
                  </div>
                </div>
              </div>

              <!-- æ–‡å­—è®¾ç½® Tab -->
              <div class="tab-content" id="tab-text">
                <div class="form-group">
                  <label for="cardTitle">å¡ç‰‡æ ‡é¢˜</label>
                  <input type="text" id="cardTitle" placeholder="è¾“å…¥å¡ç‰‡æ ‡é¢˜" maxlength="100" />
                </div>

                <div class="form-group">
                  <label for="fontFamily">å­—ä½“</label>
                  <select id="fontFamily">
                    <option value="Arial" class="font-option font-arial">Arial</option>
                    <option value="Times New Roman" class="font-option font-times">Times New Roman</option>
                    <option value="Courier New" class="font-option font-courier">Courier New</option>
                    <option value="Georgia" class="font-option font-georgia">Georgia</option>
                    <option value="Verdana" class="font-option font-verdana">Verdana</option>
                    <option value="Palatino Linotype" class="font-option font-palatino">Palatino</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="textColor">æ–‡å­—é¢œè‰²</label>
                  <div class="color-picker">
                    <input type="color" id="textColor" value="#000000" />
                    <span id="textColorValue">#000000</span>
                  </div>
                </div>

                <div class="form-group">
                  <label for="textSize">æ–‡å­—å¤§å°</label>
                  <div class="slider-container">
                    <input type="range" id="textSize" min="10" max="50" value="24" />
                    <span class="slider-value" id="textSizeValue">24</span>
                  </div>
                </div>

                <div class="form-group">
                  <label for="textShadow">æ–‡å­—é˜´å½±</label>
                  <div class="slider-container">
                    <input type="range" id="textShadow" min="0" max="10" value="0" />
                    <span class="slider-value" id="textShadowValue">0</span>
                  </div>
                </div>
              </div>

              <!-- æ°´å°è®¾ç½® Tab -->
              <div class="tab-content" id="tab-watermark">
                <div class="form-group watermark-toggle">
                  <input type="checkbox" id="enableWatermark" checked />
                  <label for="enableWatermark">å¯ç”¨æ°´å°</label>
                </div>

                <div class="watermark-group">
                  <div class="form-group">
                    <label for="watermarkText">æ°´å°æ–‡å­—</label>
                    <input type="text" id="watermarkText" placeholder="è¾“å…¥æ°´å°æ–‡å­—" value="å…¬ä¼—å·:ç§‘æŠ€ç ”ä¹ å®¤" />
                  </div>

                  <div class="form-group">
                    <label for="watermarkColor">æ°´å°é¢œè‰²</label>
                    <div class="color-picker">
                      <input type="color" id="watermarkColor" value="#000000" />
                      <span id="watermarkColorValue">#000000</span>
                    </div>
                  </div>

                  <div class="form-group">
                    <label for="watermarkOpacity">æ°´å°é€æ˜åº¦</label>
                    <div class="slider-container">
                      <input type="range" id="watermarkOpacity" min="0" max="100" value="30" />
                      <span class="slider-value" id="watermarkOpacityValue">30</span>
                    </div>
                  </div>

                  <div class="form-group">
                    <label for="watermarkSize">æ°´å°å¤§å°</label>
                    <div class="slider-container">
                      <input type="range" id="watermarkSize" min="10" max="30" value="16" />
                      <span class="slider-value" id="watermarkSizeValue">16</span>
                    </div>
                  </div>

                  <div class="form-group">
                    <label for="watermarkPosition">æ°´å°ä½ç½®</label>
                    <select id="watermarkPosition">
                      <option value="tile">æ–œé“º</option>
                      <option value="bottom-right">å³ä¸‹è§’</option>
                      <option value="bottom-left">å·¦ä¸‹è§’</option>
                      <option value="top-right">å³ä¸Šè§’</option>
                      <option value="top-left">å·¦ä¸Šè§’</option>
                      <option value="center">å±…ä¸­</option>
                    </select>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- å³ä¾§é¢„è§ˆåŒºåŸŸ -->
        <div class="preview-column">
          <div class="preview-container">
            <h3 class="preview-title">å¡ç‰‡é¢„è§ˆ</h3>
            <div id="cardPreviewContainer" class="card-preview-grid"></div>

            <!-- ç”Ÿæˆã€ä¸‹è½½å’Œé‡ç½®æŒ‰é’®æ”¾åœ¨å³ä¾§é¢„è§ˆåŒºåŸŸ -->
            <div class="preview-btn-group">
              <button id="generateBtn" class="btn">ç”Ÿæˆå¡ç‰‡</button>
              <button id="downloadBtn" class="btn" disabled>ä¸‹è½½å¡ç‰‡</button>
              <button id="resetBtn" class="btn btn-danger">é‡ç½®è®¾ç½®</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- iPhoneå¥—å£³Tabå†…å®¹ -->
    <div class="main-tab-content" id="main-tab-iphone">
      <div class="main-content">
        <!-- å·¦ä¾§è®¾ç½®åŒºåŸŸ -->
        <div class="settings-column">
          <div class="panels">
            <div class="panel">
              <h2 class="panel-title">ä¸Šä¼ å›¾ç‰‡</h2>
              <div class="form-group">
                <label for="iphoneMainImageUpload">ä¸»å›¾ç‰‡</label>
                <input type="file" id="iphoneMainImageUpload" accept="image/*" multiple />
                <div id="iphoneMainImagePreviewContainer" class="preview-list"></div>
              </div>
            </div>

            <div class="panel">
              <h2 class="panel-title">èƒŒæ™¯è®¾ç½®</h2>
              <div class="form-group">
                <label>èƒŒæ™¯ç±»å‹</label>
                <div class="bg-type-btn-group">
                  <button id="iphoneBgTypeSolidBtn" class="bg-type-btn active" data-type="solid">
                    <span class="btn-icon">ğŸ¨</span>
                    çº¯è‰²
                  </button>
                  <button id="iphoneBgTypeGradientBtn" class="bg-type-btn" data-type="gradient">
                    <span class="btn-icon">ğŸŒˆ</span>
                    æ¸å˜
                  </button>
                </div>
                <input type="radio" id="iphoneBgTypeSolid" name="iphoneBgType" value="solid" checked hidden>
                <input type="radio" id="iphoneBgTypeGradient" name="iphoneBgType" value="gradient" hidden>
              </div>

              <!-- çº¯è‰²è®¾ç½® -->
              <div id="iphoneBgSolidSettings" class="bg-settings">
                <div class="form-group">
                  <label for="iphoneBgColor">èƒŒæ™¯é¢œè‰²</label>
                  <div class="color-picker">
                    <input type="color" id="iphoneBgColor" value="#ffffff" />
                    <input type="range" id="iphoneBgOpacity" min="0" max="100" value="0" />
                    <span id="iphoneBgColorValue">#ffffff (0%)</span>
                  </div>
                </div>
              </div>

              <!-- æ¸å˜è®¾ç½® -->
              <div id="iphoneBgGradientSettings" class="bg-settings" style="display: none;">
                <div class="form-group">
                  <label>é¢„è®¾æ¸å˜</label>
                  <select id="iphoneBgGradientPreset">
                    <option value="random" selected>ğŸ² éšæœºæ¸å˜</option>
                    <option value="none">è‡ªå®šä¹‰</option>
                    <option value="sunset">å¤•é˜³ä½™æ™–</option>
                    <option value="ocean">æµ·æ´‹è“è°ƒ</option>
                    <option value="forest">æ£®æ—ç»¿æ„</option>
                    <option value="purple">ç´«è‰²æ¢¦å¹»</option>
                    <option value="pink">ç²‰è‰²è”·è–‡</option>
                    <option value="gold">é‡‘è‰²è¾‰ç…Œ</option>
                    <option value="night">é™è°§å¤œè‰²</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="iphoneBgColor1">èµ·å§‹é¢œè‰²</label>
                  <div class="color-picker">
                    <input type="color" id="iphoneBgColor1" value="#FF6B6B" />
                    <span id="iphoneBgColor1Value">#FF6B6B</span>
                  </div>
                </div>

                <div class="form-group">
                  <label for="iphoneBgColor2">ç»“æŸé¢œè‰²</label>
                  <div class="color-picker">
                    <input type="color" id="iphoneBgColor2" value="#4ECDC4" />
                    <span id="iphoneBgColor2Value">#4ECDC4</span>
                  </div>
                </div>

                <div class="form-group">
                  <label for="iphoneBgGradientAngle">æ¸å˜è§’åº¦</label>
                  <div class="slider-container">
                    <input type="range" id="iphoneBgGradientAngle" min="0" max="360" value="45" />
                    <span class="slider-value" id="iphoneBgGradientAngleValue">45Â°</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="panel">
              <h2 class="panel-title">è¾¹æ¡†é¢„è§ˆ</h2>
              <div class="form-group">
                <label>å½“å‰ä½¿ç”¨çš„è¾¹æ¡†</label>
                <div id="iphoneBorderPreview" class="border-preview-container">
                  <img id="iphoneBorderImage" src="images/iphone-border-16promax.png" alt="iPhoneè¾¹æ¡†" />
                </div>
                <p class="border-info">å½“å‰ä½¿ç”¨ï¼šiPhone 16 Pro Max è¾¹æ¡†</p>
              </div>
            </div>
          </div>
        </div>

        <!-- å³ä¾§é¢„è§ˆåŒºåŸŸ -->
        <div class="preview-column">
          <div class="preview-container">
            <h3 class="preview-title">iPhoneå¥—å£³é¢„è§ˆ</h3>
            <div id="iphonePreviewContainer" class="card-preview-grid"></div>

            <div class="preview-btn-group">
              <button id="iphoneGenerateBtn" class="btn">ç”Ÿæˆå¥—å£³</button>
              <button id="iphoneResetBtn" class="btn btn-danger">é‡ç½®è®¾ç½®</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    </div>

      <div id="imageModal" class="modal">
        <span class="close-btn">&times;</span>
        <img class="modal-content" id="modalImage" />
      </div>

      <div class="loading">
        <div class="spinner"></div>
        <p>æ­£åœ¨ç”Ÿæˆå¡ç‰‡...</p>
      </div>

      <div id="toast" class="toast"></div>

      <canvas id="canvas" style="display: none"></canvas>
    </div>

    <script>
      // DOMå…ƒç´ 
      const mainImageUploadInput = document.getElementById("mainImageUpload");
      const qrCodeImageUploadInput =
        document.getElementById("qrCodeImageUpload");
      const mainImagePreviewContainer = document.getElementById(
        "mainImagePreviewContainer"
      );
      const qrCodeImagePreviewContainer = document.getElementById(
        "qrCodeImagePreviewContainer"
      );
      const cardTitleInput = document.getElementById("cardTitle");
      const fontFamilySelect = document.getElementById("fontFamily");
      const textColorInput = document.getElementById("textColor");
      const textColorValue = document.getElementById("textColorValue");
      const textSizeInput = document.getElementById("textSize");
      const textSizeValue = document.getElementById("textSizeValue");
      const textShadowInput = document.getElementById("textShadow");
      const textShadowValue = document.getElementById("textShadowValue");
      const stylePresetSelect = document.getElementById("stylePreset");
      const bgColor1Input = document.getElementById("bgColor1");
      const bgColor1Value = document.getElementById("bgColor1Value");
      const bgColor2Input = document.getElementById("bgColor2");
      const bgColor2Value = document.getElementById("bgColor2Value");
      const gradientTypeSelect = document.getElementById("gradientType");
      const cardPaddingInput = document.getElementById("cardPadding");
      const cardPaddingValue = document.getElementById("cardPaddingValue");
      const cardRadiusInput = document.getElementById("cardRadius");
      const cardRadiusValue = document.getElementById("cardRadiusValue");
      const cardShadowInput = document.getElementById("cardShadow");
      const cardShadowValue = document.getElementById("cardShadowValue");
      // æ°´å°ç›¸å…³å…ƒç´ 
      const enableWatermarkInput = document.getElementById("enableWatermark");
      const watermarkTextInput = document.getElementById("watermarkText");
      const watermarkColorInput = document.getElementById("watermarkColor");
      const watermarkColorValue = document.getElementById(
        "watermarkColorValue"
      );
      const watermarkOpacityInput = document.getElementById("watermarkOpacity");
      const watermarkOpacityValue = document.getElementById(
        "watermarkOpacityValue"
      );
      const watermarkSizeInput = document.getElementById("watermarkSize");
      const watermarkSizeValue = document.getElementById("watermarkSizeValue");
      const watermarkPositionSelect =
        document.getElementById("watermarkPosition");
      const generateBtn = document.getElementById("generateBtn");
      const downloadBtn = document.getElementById("downloadBtn");
      const resetBtn = document.getElementById("resetBtn");
      const loadingDiv = document.querySelector(".loading");
      const toastDiv = document.getElementById("toast");
      const cardPreviewContainer = document.getElementById(
        "cardPreviewContainer"
      );
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");

      // iPhoneå¥—å£³åŠŸèƒ½DOMå…ƒç´ 
      const iphoneMainImageUploadInput = document.getElementById("iphoneMainImageUpload");
      const iphoneMainImagePreviewContainer = document.getElementById("iphoneMainImagePreviewContainer");
      const iphoneBgColorInput = document.getElementById("iphoneBgColor");
      const iphoneBgOpacityInput = document.getElementById("iphoneBgOpacity");
      const iphoneBgColorValue = document.getElementById("iphoneBgColorValue");
      const iphoneBorderImage = document.getElementById("iphoneBorderImage");

      // èƒŒæ™¯ç±»å‹å…ƒç´ 
      const iphoneBgTypeSolidBtn = document.getElementById("iphoneBgTypeSolidBtn");
      const iphoneBgTypeGradientBtn = document.getElementById("iphoneBgTypeGradientBtn");
      const iphoneBgTypeSolidInput = document.getElementById("iphoneBgTypeSolid");
      const iphoneBgTypeGradientInput = document.getElementById("iphoneBgTypeGradient");
      const iphoneBgSolidSettings = document.getElementById("iphoneBgSolidSettings");
      const iphoneBgGradientSettings = document.getElementById("iphoneBgGradientSettings");
      const iphoneBgGradientPresetSelect = document.getElementById("iphoneBgGradientPreset");
      const iphoneBgColor1Input = document.getElementById("iphoneBgColor1");
      const iphoneBgColor2Input = document.getElementById("iphoneBgColor2");
      const iphoneBgColor1Value = document.getElementById("iphoneBgColor1Value");
      const iphoneBgColor2Value = document.getElementById("iphoneBgColor2Value");
      const iphoneBgGradientAngleInput = document.getElementById("iphoneBgGradientAngle");
      const iphoneBgGradientAngleValue = document.getElementById("iphoneBgGradientAngleValue");
      const iphoneGenerateBtn = document.getElementById("iphoneGenerateBtn");
      const iphoneResetBtn = document.getElementById("iphoneResetBtn");
      const iphonePreviewContainer = document.getElementById("iphonePreviewContainer");

      // é¢„åŠ è½½ iPhone è¾¹æ¡†å›¾ç‰‡
      const borderImg = new Image();
      borderImg.src = "images/iphone-border-15promax.png";
      // æ ‡è®°å›¾ç‰‡å·²åŠ è½½ï¼ˆå¦‚æœå·²ç¼“å­˜ï¼‰
      if (borderImg.complete) {
        console.log("iPhone è¾¹æ¡†å›¾ç‰‡å·²ç¼“å­˜");
      } else {
        borderImg.onload = () => console.log("iPhone è¾¹æ¡†å›¾ç‰‡åŠ è½½å®Œæˆ");
        borderImg.onerror = () => console.error("iPhone è¾¹æ¡†å›¾ç‰‡åŠ è½½å¤±è´¥");
      }

      // åˆå§‹åŒ–æ—¶ä»æœ¬åœ°å­˜å‚¨æ¢å¤tabé€‰æ‹©
      const savedMainTab = localStorage.getItem('selectedMainTab') || 'card';

      // è®¾ç½®é»˜è®¤æ¿€æ´»çš„tab
      document.querySelectorAll(".main-tab-btn").forEach((btn) => {
        btn.classList.remove("active");
      });
      document.querySelectorAll(".main-tab-content").forEach((c) => {
        c.classList.remove("active");
      });

      // æ¿€æ´»ä¿å­˜çš„tab
      const savedTabBtn = document.querySelector(`[data-main-tab="${savedMainTab}"]`);
      if (savedTabBtn) {
        savedTabBtn.classList.add("active");
        const savedTabContent = document.getElementById(`main-tab-${savedMainTab}`);
        if (savedTabContent) {
          savedTabContent.classList.add("active");
        }
      } else {
        // å¦‚æœæœªæ‰¾åˆ°ä¿å­˜çš„tabï¼Œä½¿ç”¨é»˜è®¤å€¼
        document.querySelector(`[data-main-tab="card"]`).classList.add("active");
        document.getElementById(`main-tab-card`).classList.add("active");
      }

      // Main tabs switching functionality
      document.querySelectorAll(".main-tab-btn").forEach((btn) => {
        btn.addEventListener("click", function () {
          const tabId = this.getAttribute("data-main-tab");

          // Remove active class from all buttons and content
          document.querySelectorAll(".main-tab-btn").forEach((b) =>
            b.classList.remove("active")
          );
          document.querySelectorAll(".main-tab-content").forEach((c) =>
            c.classList.remove("active")
          );

          // Add active class to clicked button and corresponding content
          this.classList.add("active");
          document.getElementById("main-tab-" + tabId).classList.add("active");

          // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
          localStorage.setItem('selectedMainTab', tabId);
        });
      });

      // Tab switching functionality
      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.addEventListener("click", function () {
          const tabId = this.getAttribute("data-tab");

          // Remove active class from all buttons and content
          document.querySelectorAll(".tab-btn").forEach((b) => b.classList.remove("active"));
          document.querySelectorAll(".tab-content").forEach((c) => c.classList.remove("active"));

          // Add active class to clicked button and corresponding content
          this.classList.add("active");
          document.getElementById("tab-" + tabId).classList.add("active");
        });
      });

      // Helper function for natural sorting of filenames
      function naturalSortComparer(a, b) {
        // Extract numbers, default to 1 if not found (for cases like 'image.png')
        const numA = parseInt(a.name.match(/\d+/)?.[0] || "1");
        const numB = parseInt(b.name.match(/\d+/)?.[0] || "1");

        // If numbers are different, sort by number
        if (numA !== numB) {
          return numA - numB;
        }

        // If numbers are the same (or both are 1), sort by the full name as a fallback
        return a.name.localeCompare(b.name);
      }

      let mainImageFiles = [];
      let qrCodeImageFiles = [];

      mainImageUploadInput.addEventListener("change", (e) => {
        mainImageFiles = Array.from(e.target.files).sort(naturalSortComparer);
        updatePreview(mainImagePreviewContainer, mainImageFiles);
      });

      qrCodeImageUploadInput.addEventListener("change", (e) => {
        qrCodeImageFiles = Array.from(e.target.files).sort(naturalSortComparer);
        updatePreview(qrCodeImagePreviewContainer, qrCodeImageFiles);
      });

      function updatePreview(container, files) {
        container.innerHTML = ""; // æ¸…ç©ºç°æœ‰é¢„è§ˆ
        files.forEach((file) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = document.createElement("img");
            img.src = e.target.result;
            img.classList.add("image-preview");
            img.style.cursor = "pointer";
            img.onclick = () => openModal(e.target.result);
            container.appendChild(img);
          };
          reader.readAsDataURL(file);
        });
      }

      // iPhoneå¥—å£³é¢„è§ˆæ›´æ–°å‡½æ•°
      function updateIphonePreview(container, files) {
        container.innerHTML = ""; // æ¸…ç©ºç°æœ‰é¢„è§ˆ
        files.forEach((file) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = document.createElement("img");
            img.src = e.target.result;
            img.classList.add("image-preview");
            img.style.cursor = "pointer";
            img.onclick = () => openModal(e.target.result);
            container.appendChild(img);
          };
          reader.readAsDataURL(file);
        });
      }

      // iPhoneå¥—å£³ç”Ÿæˆå‡½æ•°
      async function generateIPhoneCards() {
        if (iphoneMainImageFiles.length === 0) {
          showToast("è¯·å…ˆä¸Šä¼ ä¸»å›¾ç‰‡");
          return;
        }

        iphoneGenerateBtn.disabled = true;
        iphoneGenerateBtn.textContent = "ç”Ÿæˆä¸­...";
        loadingDiv.classList.add("show");

        iphonePreviewContainer.innerHTML = "";

        try {
          const images = await Promise.all(
            iphoneMainImageFiles.map((file) => loadImageAsync(URL.createObjectURL(file)))
          );

          for (let i = 0; i < images.length; i++) {
            const mainImage = images[i];
            const canvas = document.createElement("canvas");
            const ctx = canvas.getContext("2d");

            // è®¾ç½®iPhoneå¥—å£³ç”»å¸ƒå°ºå¯¸ (1400x2820)
            canvas.width = 1400;
            canvas.height = 2820;

            // è®¾ç½®æ•´ä¸ªcanvasçš„èƒŒæ™¯
            const bgType = iphoneBgTypeSolidInput.checked ? 'solid' : 'gradient';

            if (bgType === 'gradient') {
              // å¦‚æœæ˜¯éšæœºæ¸å˜ï¼Œæ¯æ¬¡éƒ½é‡æ–°ç”Ÿæˆ
              if (iphoneBgGradientPresetSelect.value === 'random') {
                const randomGradient = generateRandomGradient();
                const color1 = '#' + randomGradient.color1;
                const color2 = '#' + randomGradient.color2;
                const angle = randomGradient.angle;

                // ç»˜åˆ¶éšæœºæ¸å˜èƒŒæ™¯
                const radians = (angle - 90) * Math.PI / 180;
                const x1 = canvas.width / 2 - Math.cos(radians) * canvas.width;
                const y1 = canvas.height / 2 - Math.sin(radians) * canvas.height;
                const x2 = canvas.width / 2 + Math.cos(radians) * canvas.width;
                const y2 = canvas.height / 2 + Math.sin(radians) * canvas.height;

                const gradient = ctx.createLinearGradient(x1, y1, x2, y2);
                gradient.addColorStop(0, color1);
                gradient.addColorStop(1, color2);

                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
              } else {
                // ç»˜åˆ¶æ­£å¸¸æ¸å˜èƒŒæ™¯
                const color1 = iphoneBgColor1Input.value;
                const color2 = iphoneBgColor2Input.value;
                const angle = parseInt(iphoneBgGradientAngleInput.value);

                // è®¡ç®—æ¸å˜çš„æ–¹å‘
                const radians = (angle - 90) * Math.PI / 180;
                const x1 = canvas.width / 2 - Math.cos(radians) * canvas.width;
                const y1 = canvas.height / 2 - Math.sin(radians) * canvas.height;
                const x2 = canvas.width / 2 + Math.cos(radians) * canvas.width;
                const y2 = canvas.height / 2 + Math.sin(radians) * canvas.height;

                const gradient = ctx.createLinearGradient(x1, y1, x2, y2);
                gradient.addColorStop(0, color1);
                gradient.addColorStop(1, color2);

                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
              }
            } else {
              // ç»˜åˆ¶çº¯è‰²èƒŒæ™¯
              const bgColor = iphoneBgColorInput.value;
              const bgOpacity = iphoneBgOpacityInput.value / 100;
              if (bgOpacity > 0) {
                ctx.fillStyle = bgColor + Math.floor(bgOpacity * 255).toString(16).padStart(2, '0');
                ctx.fillRect(0, 0, canvas.width, canvas.height);
              }
            }

            // ç»˜åˆ¶iPhoneå¥—å£³
            await drawIPhoneMockupForCanvas(ctx, canvas, mainImage, null);

            // åˆ›å»ºé¢„è§ˆå®¹å™¨
            const previewItem = document.createElement("div");
            previewItem.classList.add("card-preview-item");

            const previewImg = document.createElement("img");
            previewImg.src = canvas.toDataURL();
            previewImg.classList.add("card-image");
            previewImg.style.cursor = "pointer";
            previewImg.onclick = () => openModal(canvas.toDataURL());
            previewItem.appendChild(previewImg);

            // æ·»åŠ ä¸‹è½½å’Œå¤åˆ¶æŒ‰é’®
            const btnGroup = document.createElement("div");
            btnGroup.classList.add("card-btn-group");

            const downloadCurrentBtn = document.createElement("button");
            downloadCurrentBtn.classList.add("btn", "btn-small", "btn-primary");
            downloadCurrentBtn.textContent = "ä¸‹è½½";
            downloadCurrentBtn.onclick = () => {
              const link = document.createElement("a");
              link.download = `iphone-card-${i + 1}.png`;
              link.href = canvas.toDataURL();
              link.click();
            };
            btnGroup.appendChild(downloadCurrentBtn);

            const copyBtn = document.createElement("button");
            copyBtn.classList.add("btn", "btn-small", "btn-secondary");
            copyBtn.textContent = "å¤åˆ¶";
            copyBtn.onclick = async () => {
              try {
                const response = await fetch(canvas.toDataURL());
                const blob = await response.blob();
                await navigator.clipboard.write([
                  new ClipboardItem({ [blob.type]: blob }),
                ]);
                showToast("å›¾ç‰‡å·²å¤åˆ¶åˆ°å‰ªè´´æ¿", "success");
              } catch (err) {
                console.error("å¤åˆ¶å›¾ç‰‡å¤±è´¥:", err);
                showToast("å¤åˆ¶å¤±è´¥ï¼Œè¯·ä½¿ç”¨ä¸‹è½½æ–¹å¼", "error");
              }
            };
            btnGroup.appendChild(copyBtn);

            previewItem.appendChild(btnGroup);
            iphonePreviewContainer.appendChild(previewItem);
          }

          showToast("iPhoneå¥—å£³ç”Ÿæˆå®Œæˆï¼");
        } catch (error) {
          console.error("ç”ŸæˆiPhoneå¥—å£³æ—¶å‡ºé”™:", error);
          showToast("ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•");
        } finally {
          iphoneGenerateBtn.disabled = false;
          iphoneGenerateBtn.textContent = "ç”Ÿæˆå¥—å£³";
          loadingDiv.classList.remove("show");
        }
      }

      // iPhoneå¥—å£³ç»˜åˆ¶å‡½æ•°
      async function drawIPhoneMockupForCanvas(ctx, canvas, mainImage, qrCodeImage) {
        // é¢„åŠ è½½è¾¹æ¡†å›¾ç‰‡
        if (!window.iphoneBorderImg || !window.iphoneBorderImg.complete) {
          window.iphoneBorderImg = new Image();
          window.iphoneBorderImg.src = "images/iphone-border-16promax.png";
          await new Promise((resolve, reject) => {
            window.iphoneBorderImg.onload = resolve;
            window.iphoneBorderImg.onerror = reject;
          });
        }

        const borderImg = window.iphoneBorderImg;
        const canvasW = 1400;
        const canvasH = 2820;
        const borderSrcW = borderImg.naturalWidth || 1400;
        const borderSrcH = borderImg.naturalHeight || 2820;

        // è¾¹æ¡†è®¾ç½®
        const borderW = 1195;
        const borderH = borderSrcH * (borderW / borderSrcW);
        const drawBorderX = (canvasW - borderW) / 2;
        const drawBorderY = (canvasH - borderH) / 2;

        // ä¸»å›¾ç‰‡è®¾ç½®
        const imgW = 1076;
        const imgRadius = 150;
        const imgX = (canvasW - imgW) / 2;
        const imgY = (canvasH - (mainImage.height * (imgW / mainImage.width))) / 2;
        const imgH = mainImage.height * (imgW / mainImage.width);

        // ç»˜åˆ¶ä¸»å›¾ç‰‡
        ctx.save();
        ctx.beginPath();
        ctx.roundRect(imgX, imgY, imgW, imgH, imgRadius);
        ctx.clip();
        ctx.drawImage(mainImage, imgX, imgY, imgW, imgH);
        ctx.restore();

        // ç»˜åˆ¶è¾¹æ¡†
        ctx.save();
        ctx.shadowColor = "rgba(0, 0, 0, 0.4)";
        ctx.shadowBlur = 50;
        ctx.shadowOffsetX = 10;
        ctx.shadowOffsetY = 20;
        ctx.drawImage(borderImg, 0, 0, borderSrcW, borderSrcH, drawBorderX, drawBorderY, borderW, borderH);
        ctx.restore();


      }


      // iPhoneå¥—å£³é‡ç½®å‡½æ•°
      function resetIPhoneForm() {
        iphoneMainImageFiles = [];
        iphoneMainImageUploadInput.value = "";

        // é‡ç½®èƒŒæ™¯ä¸ºçº¯è‰²é€æ˜
        iphoneBgTypeSolidBtn.classList.add("active");
        iphoneBgTypeGradientBtn.classList.remove("active");
        iphoneBgTypeSolidInput.checked = true;
        iphoneBgTypeGradientInput.checked = false;
        iphoneBgSolidSettings.style.display = "block";
        iphoneBgGradientSettings.style.display = "none";

        iphoneBgColorInput.value = "#ffffff";
        iphoneBgOpacityInput.value = "0";
        iphoneBgColorValue.textContent = "#ffffff (0%)";

        iphoneMainImagePreviewContainer.innerHTML = "";
        iphonePreviewContainer.innerHTML = "";
      }

      // é¢œè‰²é€‰æ‹©å™¨å€¼æ˜¾ç¤º
      textColorInput.addEventListener("input", function () {
        textColorValue.textContent = textColorInput.value;
      });

      bgColor1Input.addEventListener("input", function () {
        bgColor1Value.textContent = bgColor1Input.value;
      });

      bgColor2Input.addEventListener("input", function () {
        bgColor2Value.textContent = bgColor2Input.value;
      });

      // æ°´å°é¢œè‰²é€‰æ‹©å™¨å€¼æ˜¾ç¤º
      watermarkColorInput.addEventListener("input", function () {
        watermarkColorValue.textContent = watermarkColorInput.value;
      });

      // æ»‘å—å€¼æ˜¾ç¤º
      textSizeInput.addEventListener("input", function () {
        textSizeValue.textContent = textSizeInput.value;
      });

      textShadowInput.addEventListener("input", function () {
        textShadowValue.textContent = textShadowInput.value;
      });

      cardPaddingInput.addEventListener("input", function () {
        cardPaddingValue.textContent = cardPaddingInput.value;
      });

      cardRadiusInput.addEventListener("input", function () {
        cardRadiusValue.textContent = cardRadiusInput.value;
      });

      cardShadowInput.addEventListener("input", function () {
        cardShadowValue.textContent = cardShadowInput.value;
      });

      // æ°´å°æ»‘å—å€¼æ˜¾ç¤º
      watermarkOpacityInput.addEventListener("input", function () {
        watermarkOpacityValue.textContent = watermarkOpacityInput.value;
      });

      watermarkSizeInput.addEventListener("input", function () {
        watermarkSizeValue.textContent = watermarkSizeInput.value;
      });

      // ç”Ÿæˆå¡ç‰‡
      generateBtn.addEventListener("click", function (e) {
        e.preventDefault();
        generateCard();
      });

      // ä¸‹è½½å¡ç‰‡
      downloadBtn.style.display = "none"; // éšè—å…¨å±€ä¸‹è½½æŒ‰é’®

      // é‡ç½®è¡¨å•
      resetBtn.addEventListener("click", resetForm);

      // iPhoneå¥—å£³åŠŸèƒ½äº‹ä»¶ç›‘å¬å™¨
      let iphoneMainImageFiles = [];

      // é¢„åŠ è½½è¾¹æ¡†å›¾ç‰‡
      const borderPreviewImg = new Image();
      borderPreviewImg.src = "images/iphone-border-16promax.png";
      borderPreviewImg.onload = () => {
        console.log("è¾¹æ¡†é¢„è§ˆå›¾ç‰‡åŠ è½½å®Œæˆ");
      };
      borderPreviewImg.onerror = () => {
        console.error("è¾¹æ¡†é¢„è§ˆå›¾ç‰‡åŠ è½½å¤±è´¥");
        // å¦‚æœæ‰¾ä¸åˆ°è¾¹æ¡†å›¾ç‰‡ï¼Œéšè—é¢„è§ˆåŒºåŸŸ
        const borderPreview = document.getElementById("iphoneBorderPreview");
        if (borderPreview) {
          borderPreview.style.display = "none";
        }
        const borderInfo = document.querySelector(".border-info");
        if (borderInfo) {
          borderInfo.textContent = "è¾¹æ¡†å›¾ç‰‡æœªæ‰¾åˆ°";
        }
      };

      iphoneMainImageUploadInput.addEventListener("change", (e) => {
        iphoneMainImageFiles = Array.from(e.target.files).sort(naturalSortComparer);
        updateIphonePreview(iphoneMainImagePreviewContainer, iphoneMainImageFiles);
      });

      // èƒŒæ™¯è‰²é€æ˜åº¦å€¼æ›´æ–°
      iphoneBgOpacityInput.addEventListener("input", () => {
        const color = iphoneBgColorInput.value;
        const opacity = iphoneBgOpacityInput.value;
        iphoneBgColorValue.textContent = `${color} (${opacity}%)`;
      });

      // èƒŒæ™¯é¢œè‰²å€¼æ›´æ–°
      iphoneBgColorInput.addEventListener("input", () => {
        const color = iphoneBgColorInput.value;
        const opacity = iphoneBgOpacityInput.value;
        iphoneBgColorValue.textContent = `${color} (${opacity}%)`;
      });

      // è¾¹æ¡†å›¾ç‰‡ç‚¹å‡»é¢„è§ˆ
      iphoneBorderImage.addEventListener("click", () => {
        openModal(iphoneBorderImage.src);
      });

      // èƒŒæ™¯ç±»å‹åˆ‡æ¢
      iphoneBgTypeSolidBtn.addEventListener("click", () => {
        iphoneBgTypeSolidBtn.classList.add("active");
        iphoneBgTypeGradientBtn.classList.remove("active");
        iphoneBgTypeSolidInput.checked = true;
        iphoneBgSolidSettings.style.display = "block";
        iphoneBgGradientSettings.style.display = "none";
      });

      iphoneBgTypeGradientBtn.addEventListener("click", () => {
        iphoneBgTypeGradientBtn.classList.add("active");
        iphoneBgTypeSolidBtn.classList.remove("active");
        iphoneBgTypeGradientInput.checked = true;
        iphoneBgSolidSettings.style.display = "none";
        iphoneBgGradientSettings.style.display = "block";
      });

      // æ¸å˜é¢„è®¾é€‰æ‹©
      const gradientPresets = {
        sunset: { color1: "#FF6B6B", color2: "#4ECDC4", angle: 135 },
        ocean: { color1: "#667eea", color2: "#764ba2", angle: 90 },
        forest: { color1: "#11998e", color2: "#38ef7d", angle: 135 },
        purple: { color1: "#ee0979", color2: "#ff6a00", angle: 45 },
        pink: { color1: "#f093fb", color2: "#f5576c", angle: 180 },
        gold: { color1: "#f7971e", color2: "#ffd200", angle: 45 },
        night: { color1: "#0f0c29", color2: "#302b63", angle: 90 }
      };

      // ç”Ÿæˆéšæœºæ¸å˜
      function generateRandomGradient() {
        const randomColor = () => {
          const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F'];
          return colors[Math.floor(Math.random() * colors.length)];
        };

        const color1 = randomColor();
        let color2 = randomColor();
        // ç¡®ä¿ä¸¤ä¸ªé¢œè‰²ä¸åŒ
        while (color2 === color1) {
          color2 = randomColor();
        }

        const angle = Math.floor(Math.random() * 360);

        return {
          color1: color1.substring(1), // ç§»é™¤#å·
          color2: color2.substring(1), // ç§»é™¤#å·
          angle: angle
        };
      }

      iphoneBgGradientPresetSelect.addEventListener("change", () => {
        const value = iphoneBgGradientPresetSelect.value;

        if (value === 'random') {
          const randomGradient = generateRandomGradient();
          iphoneBgColor1Input.value = '#' + randomGradient.color1;
          iphoneBgColor2Input.value = '#' + randomGradient.color2;
          iphoneBgGradientAngleInput.value = randomGradient.angle;
          iphoneBgColor1Value.textContent = '#' + randomGradient.color1;
          iphoneBgColor2Value.textContent = '#' + randomGradient.color2;
          iphoneBgGradientAngleValue.textContent = randomGradient.angle + "Â°";
        } else {
          const preset = gradientPresets[value];
          if (preset) {
            iphoneBgColor1Input.value = preset.color1;
            iphoneBgColor2Input.value = preset.color2;
            iphoneBgGradientAngleInput.value = preset.angle;
            iphoneBgColor1Value.textContent = preset.color1;
            iphoneBgColor2Value.textContent = preset.color2;
            iphoneBgGradientAngleValue.textContent = preset.angle + "Â°";
          }
        }
      });

      // é¢œè‰²é€‰æ‹©å™¨å€¼æ›´æ–°
      iphoneBgColor1Input.addEventListener("input", () => {
        iphoneBgColor1Value.textContent = iphoneBgColor1Input.value;
        iphoneBgGradientPresetSelect.value = "none";
      });

      iphoneBgColor2Input.addEventListener("input", () => {
        iphoneBgColor2Value.textContent = iphoneBgColor2Input.value;
        iphoneBgGradientPresetSelect.value = "none";
      });

      // æ¸å˜è§’åº¦æ›´æ–°
      iphoneBgGradientAngleInput.addEventListener("input", () => {
        iphoneBgGradientAngleValue.textContent = iphoneBgGradientAngleInput.value + "Â°";
        iphoneBgGradientPresetSelect.value = "none";
      });

      // iPhoneå¥—å£³ç”ŸæˆæŒ‰é’®
      iphoneGenerateBtn.addEventListener("click", generateIPhoneCards);

      // iPhoneå¥—å£³ä¸‹è½½æŒ‰é’®

      // iPhoneå¥—å£³é‡ç½®æŒ‰é’®
      iphoneResetBtn.addEventListener("click", resetIPhoneForm);

      // åŠ è½½å›¾ç‰‡å‡½æ•°
      function loadImage(file, previewElement) {
        if (!file) {
          previewElement.src = "";
          previewElement.style.display = "none";
          return;
        }

        // éªŒè¯å›¾ç‰‡ç±»å‹
        const validTypes = [
          "image/jpeg",
          "image/png",
          "image/gif",
          "image/webp",
        ];
        if (!validTypes.includes(file.type)) {
          showMessage("è¯·ä¸Šä¼ æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ (JPEG, PNG, GIF, WEBP)", "error");
          previewElement.src = "";
          previewElement.style.display = "none";
          return;
        }

        // éªŒè¯å›¾ç‰‡å¤§å° (æœ€å¤§5MB)
        if (file.size > 5 * 1024 * 1024) {
          showMessage("å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB", "error");
          previewElement.src = "";
          previewElement.style.display = "none";
          return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          previewElement.src = e.target.result;
          previewElement.style.display = "block";
        };
        reader.readAsDataURL(file);
      }

      // ç”Ÿæˆå¡ç‰‡å‡½æ•°
      async function generateCard() {
        if (mainImageFiles.length === 0) {
          showMessage("è¯·è‡³å°‘ä¸Šä¼ ä¸€å¼ ä¸»å›¾ç‰‡", "error");
          return;
        }

        loadingDiv.classList.add("show");
        cardPreviewContainer.innerHTML = ""; // æ¸…ç©ºé¢„è§ˆ
        downloadBtn.disabled = true;

        const pairings = Math.min(
          mainImageFiles.length,
          qrCodeImageFiles.length
        );

        try {
          for (let i = 0; i < mainImageFiles.length; i++) {
            const mainImageFile = mainImageFiles[i];
            const qrCodeFile = i < pairings ? qrCodeImageFiles[i] : null;

            const mainImage = await loadImageAsync(
              URL.createObjectURL(mainImageFile)
            );
            const qrCodeImage = qrCodeFile
              ? await loadImageAsync(URL.createObjectURL(qrCodeFile))
              : null;

            // è®¾ç½®ç”»å¸ƒå°ºå¯¸
            const cardWidth = 900;
            const cardHeight = 1200;
            canvas.width = cardWidth;
            canvas.height = cardHeight;

            // ç»˜åˆ¶èƒŒæ™¯
            drawBackground();

            // ç»˜åˆ¶å¡ç‰‡å†…å®¹
            const padding = parseInt(cardPaddingInput.value);
            const radius = parseInt(cardRadiusInput.value);
            const shadow = parseInt(cardShadowInput.value);
            drawCardArea(padding, radius, shadow);

            // ç»˜åˆ¶æ°´å°
            if (enableWatermarkInput.checked) {
              drawWatermark();
            }

            // iPhoneå¥—å£³åŠŸèƒ½å·²ç§»åˆ°ç‹¬ç«‹tabï¼Œä¸å†åœ¨å¡ç‰‡ç”Ÿæˆä¸­å¤„ç†

            const contentWidth = cardWidth - 2 * padding;
            const contentHeight = cardHeight - 2 * padding;
            const spacing = contentWidth * 0.05; // Adjust spacing for the new layout

            // ç»˜åˆ¶ä¸»å›¾ç‰‡
            const mainImageRatio = mainImage.width / mainImage.height;
            let mainImageHeight, mainImageWidth, mainImageX, mainImageY;

            if (qrCodeImage) {
              // Left-Right Layout
              const qrCodeSize = contentWidth * 0.25; // Allocate space for QR code
              const mainImageMaxWidth = contentWidth - qrCodeSize - spacing * 2;
              const mainImageMaxHeight = contentHeight * 0.95;

              mainImageWidth = mainImageMaxWidth;
              mainImageHeight = mainImageWidth / mainImageRatio;

              if (mainImageHeight > mainImageMaxHeight) {
                mainImageHeight = mainImageMaxHeight;
                mainImageWidth = mainImageHeight * mainImageRatio;
              }

              mainImageX = padding + spacing;
              mainImageY = padding + (contentHeight - mainImageHeight) / 2;

              // ç»˜åˆ¶åœ†è§’ä¸»å›¾ç‰‡
              ctx.save();
              ctx.beginPath();
              ctx.roundRect(mainImageX, mainImageY, mainImageWidth, mainImageHeight, 60);
              ctx.clip();
              ctx.drawImage(
                mainImage,
                mainImageX,
                mainImageY,
                mainImageWidth,
                mainImageHeight
              );
              ctx.restore();

              // ç»˜åˆ¶äºŒç»´ç 
              const finalQrCodeSize = Math.min(
                qrCodeSize,
                qrCodeImage.width,
                qrCodeImage.height
              );
              const qrCodeX = cardWidth - padding - spacing - finalQrCodeSize;
              const qrCodeY = padding + (contentHeight - finalQrCodeSize) / 2;

              ctx.fillStyle = "white";
              ctx.fillRect(
                qrCodeX - 5,
                qrCodeY - 5,
                finalQrCodeSize + 10,
                finalQrCodeSize + 10
              );
              ctx.drawImage(
                qrCodeImage,
                qrCodeX,
                qrCodeY,
                finalQrCodeSize,
                finalQrCodeSize
              );
            } else {
              // No QR code, center the main image
              mainImageHeight = contentHeight * 0.95;
              mainImageWidth = mainImageHeight * mainImageRatio;
              if (mainImageWidth > contentWidth * 0.95) {
                mainImageWidth = contentWidth * 0.95;
                mainImageHeight = mainImageWidth / mainImageRatio;
              }
              mainImageX = padding + (contentWidth - mainImageWidth) / 2;
              mainImageY = padding + (contentHeight - mainImageHeight) / 2;

              // ç»˜åˆ¶åœ†è§’ä¸»å›¾ç‰‡
              ctx.save();
              ctx.beginPath();
              ctx.roundRect(mainImageX, mainImageY, mainImageWidth, mainImageHeight, 150);
              ctx.clip();
              ctx.drawImage(
                mainImage,
                mainImageX,
                mainImageY,
                mainImageWidth,
                mainImageHeight
              );
              ctx.restore();
            }

            // ç»˜åˆ¶æ ‡é¢˜
            if (cardTitleInput.value.trim()) {
              const text = cardTitleInput.value.trim();
              const fontSize = parseInt(textSizeInput.value);
              const fontFamily = fontFamilySelect.value;
              const textColor = textColorInput.value;
              const textShadow = parseInt(textShadowInput.value);

              ctx.font = `bold ${fontSize}px ${fontFamily}`;
              ctx.textAlign = "center";
              ctx.textBaseline = "top";

              if (textShadow > 0) {
                ctx.shadowColor = "rgba(0, 0, 0, 0.5)";
                ctx.shadowBlur = textShadow;
                ctx.shadowOffsetX = textShadow / 2;
                ctx.shadowOffsetY = textShadow / 2;
              }

              const lines = wrapTextImproved(
                ctx,
                text,
                contentWidth - 60,
                fontSize
              );
              const lineHeight = fontSize * 1.3;
              const totalTextHeight = lines.length * lineHeight;
              const textX = cardWidth / 2;
              let textY = padding + 15;

              const textBgPadding = 10;
              const textBgWidth = contentWidth - 40;
              const textBgHeight = totalTextHeight + textBgPadding * 2;
              const textBgX = (cardWidth - textBgWidth) / 2;
              const textBgY = textY - textBgPadding;

              ctx.fillStyle = "rgba(255, 255, 255, 0.7)";
              roundRect(
                ctx,
                textBgX,
                textBgY,
                textBgWidth,
                textBgHeight,
                5,
                true,
                false
              );

              ctx.fillStyle = textColor;
              for (let j = 0; j < lines.length; j++) {
                ctx.fillText(lines[j], textX, textY + j * lineHeight);
              }

              ctx.shadowColor = "transparent";
              ctx.shadowBlur = 0;
              ctx.shadowOffsetX = 0;
              ctx.shadowOffsetY = 0;
            }

            // åˆ›å»ºé¢„è§ˆé¡¹
            const dataUrl = canvas.toDataURL("image/png");
            const previewItem = document.createElement("div");
            previewItem.classList.add("preview-item");

            const img = document.createElement("img");
            img.src = dataUrl;
            img.onclick = () => openModal(dataUrl);

            const downloadButton = document.createElement("button");
            downloadButton.textContent = "ä¸‹è½½";
            downloadButton.classList.add("download-btn");
            downloadButton.onclick = () => {
              const link = document.createElement("a");
              const mainImageName = mainImageFile.name
                .split(".")
                .slice(0, -1)
                .join(".");
              link.download = `${mainImageName}_card.png`;
              link.href = dataUrl;
              link.click();
            };

            const copyButton = document.createElement("button");
            copyButton.textContent = "å¤åˆ¶";
            copyButton.classList.add("download-btn");

            copyButton.onclick = async () => {
              try {
                const response = await fetch(dataUrl);
                const blob = await response.blob();
                await navigator.clipboard.write([
                  new ClipboardItem({ [blob.type]: blob }),
                ]);
                showMessage("å›¾ç‰‡å·²å¤åˆ¶åˆ°å‰ªè´´æ¿", "success");
              } catch (err) {
                console.error("å¤åˆ¶å›¾ç‰‡å¤±è´¥:", err);
                showMessage("å¤åˆ¶å¤±è´¥ï¼Œè¯·ä½¿ç”¨ä¸‹è½½æ–¹å¼", "error");
              }
            };

            previewItem.appendChild(img);
            previewItem.appendChild(downloadButton);
            previewItem.appendChild(copyButton);
            cardPreviewContainer.appendChild(previewItem);
          }

          showMessage(`æˆåŠŸç”Ÿæˆ ${mainImageFiles.length} å¼ å¡ç‰‡!`, "success");
        } catch (error) {
          console.error("ç”Ÿæˆå¡ç‰‡å‡ºé”™:", error);
          showMessage("ç”Ÿæˆå¡ç‰‡æ—¶å‡ºé”™: " + error.message, "error");
        } finally {
          loadingDiv.classList.remove("show");
        }
      }

      // å¼‚æ­¥åŠ è½½å›¾ç‰‡
      function loadImageAsync(src) {
        return new Promise((resolve, reject) => {
          if (!src) {
            resolve(null);
            return;
          }

          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = () => reject(new Error("å›¾ç‰‡åŠ è½½å¤±è´¥"));
          img.src = src;
        });
      }

      // ç»˜åˆ¶èƒŒæ™¯
      function drawBackground() {
        let bgColor1 = bgColor1Input.value;
        let bgColor2 = bgColor2Input.value;
        const gradientType = gradientTypeSelect.value;

        // éªŒè¯é¢œè‰²å€¼æ˜¯å¦æœ‰æ•ˆï¼Œå¦‚æœæ— æ•ˆåˆ™ä½¿ç”¨é»˜è®¤å€¼
        if (!/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(bgColor1)) {
          bgColor1 = "#D5E7FB"; // é»˜è®¤é¢œè‰²1
        }
        if (!/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(bgColor2)) {
          bgColor2 = "#9EBEFA"; // é»˜è®¤é¢œè‰²2
        }

        let gradient;

        if (gradientType === "circle") {
          // å¾„å‘æ¸å˜
          gradient = ctx.createRadialGradient(
            canvas.width / 2,
            canvas.height / 2,
            0,
            canvas.width / 2,
            canvas.height / 2,
            Math.max(canvas.width, canvas.height) / 2
          );
        } else {
          // çº¿æ€§æ¸å˜
          let x0, y0, x1, y1;

          switch (gradientType) {
            case "to right":
              x0 = 0;
              y0 = 0;
              x1 = canvas.width;
              y1 = 0;
              break;
            case "to bottom":
              x0 = 0;
              y0 = 0;
              x1 = 0;
              y1 = canvas.height;
              break;
            case "to right bottom":
              x0 = 0;
              y0 = 0;
              x1 = canvas.width;
              y1 = canvas.height;
              break;
          }

          // ç¡®ä¿æ¸å˜åæ ‡æ˜¯æœ‰é™çš„æ•°å­—
          if (
            !isFinite(x0) ||
            !isFinite(y0) ||
            !isFinite(x1) ||
            !isFinite(y1)
          ) {
            console.warn(
              "Gradient coordinates are non-finite, using fallback."
            );
            x0 = 0;
            y0 = 0;
            x1 = canvas.width;
            y1 = canvas.height; // Fallback to a safe gradient
          }

          gradient = ctx.createLinearGradient(x0, y0, x1, y1);
        }

        gradient.addColorStop(0, bgColor1);
        gradient.addColorStop(1, bgColor2);

        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }

      // ç»˜åˆ¶å¡ç‰‡åŒºåŸŸ
      function drawCardArea(padding, radius, shadow) {
        const x = padding;
        const y = padding;
        const width = canvas.width - 2 * padding;
        const height = canvas.height - 2 * padding;

        // ç¡®ä¿åœ†è§’åŠå¾„ä¸è¶…è¿‡å¡ç‰‡å°ºå¯¸çš„é™åˆ¶
        radius = Math.min(radius, Math.min(width / 2, height / 2));

        // ä¿å­˜å½“å‰ç»˜å›¾çŠ¶æ€
        ctx.save();

        // ç»˜åˆ¶é˜´å½±
        if (shadow > 0) {
          ctx.shadowColor = "rgba(0, 0, 0, 0.3)";
          ctx.shadowBlur = shadow;
          ctx.shadowOffsetX = shadow / 2;
          ctx.shadowOffsetY = shadow / 2;
        }

        // ç»˜åˆ¶åœ†è§’çŸ©å½¢
        roundRect(ctx, x, y, width, height, radius, true, false);

        // ä¸å¡«å……ç™½è‰²èƒŒæ™¯ï¼Œä¿ç•™æ¸å˜èƒŒæ™¯
        // ctx.fillStyle = "white";
        // ctx.fill();

        // é‡ç½®é˜´å½±
        ctx.shadowColor = "transparent";
        ctx.shadowBlur = 0;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 0;

        // æ¢å¤ç»˜å›¾çŠ¶æ€
        ctx.restore();
      }


      // ç»˜åˆ¶åœ†è§’çŸ©å½¢ - æ”¹è¿›ç‰ˆï¼Œä½¿ç”¨arcToæ–¹æ³•æ›´ç²¾ç¡®åœ°ç»˜åˆ¶åœ†è§’
      function roundRect(ctx, x, y, width, height, radius, fill, stroke) {
        // ç¡®ä¿åŠå¾„ä¸è¶…è¿‡å®½åº¦å’Œé«˜åº¦çš„ä¸€åŠ
        radius = Math.min(radius, Math.min(width / 2, height / 2));

        ctx.beginPath();

        // ä»å·¦ä¸Šè§’å¼€å§‹ï¼Œé¡ºæ—¶é’ˆç»˜åˆ¶
        ctx.moveTo(x + radius, y);

        // ä¸Šè¾¹
        ctx.lineTo(x + width - radius, y);
        // å³ä¸Šè§’
        ctx.arcTo(x + width, y, x + width, y + radius, radius);

        // å³è¾¹
        ctx.lineTo(x + width, y + height - radius);
        // å³ä¸‹è§’
        ctx.arcTo(
          x + width,
          y + height,
          x + width - radius,
          y + height,
          radius
        );

        // ä¸‹è¾¹
        ctx.lineTo(x + radius, y + height);
        // å·¦ä¸‹è§’
        ctx.arcTo(x, y + height, x, y + height - radius, radius);

        // å·¦è¾¹
        ctx.lineTo(x, y + radius);
        // å·¦ä¸Šè§’
        ctx.arcTo(x, y, x + radius, y, radius);

        ctx.closePath();

        if (fill) {
          ctx.fill();
        }
        if (stroke) {
          ctx.stroke();
        }
      }

      // ä¼˜åŒ–çš„æ–‡å­—æ¢è¡Œå‡½æ•° - æ”¯æŒä¸­æ–‡å’Œè‹±æ–‡
      function wrapTextImproved(context, text, maxWidth, fontSize) {
        // æ£€æµ‹æ˜¯å¦åŒ…å«ä¸­æ–‡å­—ç¬¦
        const containsChinese = /[\u4e00-\u9fa5]/.test(text);

        if (containsChinese) {
          // ä¸­æ–‡æ–‡æœ¬å¤„ç† - æŒ‰å­—ç¬¦åˆ†å‰²
          return wrapChineseText(context, text, maxWidth);
        } else {
          // è‹±æ–‡æ–‡æœ¬å¤„ç† - æŒ‰å•è¯åˆ†å‰²
          return wrapEnglishText(context, text, maxWidth);
        }
      }

      // ä¸­æ–‡æ–‡æœ¬æ¢è¡Œ
      function wrapChineseText(context, text, maxWidth) {
        const lines = [];
        let currentLine = "";

        // é€å­—ç¬¦æ£€æŸ¥
        for (let i = 0; i < text.length; i++) {
          const char = text[i];
          const testLine = currentLine + char;
          const metrics = context.measureText(testLine);
          const testWidth = metrics.width;

          if (testWidth > maxWidth && currentLine !== "") {
            lines.push(currentLine);
            currentLine = char;
          } else {
            currentLine = testLine;
          }
        }

        // æ·»åŠ æœ€åä¸€è¡Œ
        if (currentLine !== "") {
          lines.push(currentLine);
        }

        return lines;
      }

      // è‹±æ–‡æ–‡æœ¬æ¢è¡Œ
      function wrapEnglishText(context, text, maxWidth) {
        const words = text.split(" ");
        const lines = [];
        let currentLine = words[0];

        for (let i = 1; i < words.length; i++) {
          const word = words[i];
          const width = context.measureText(currentLine + " " + word).width;

          if (width < maxWidth) {
            currentLine += " " + word;
          } else {
            lines.push(currentLine);
            currentLine = word;
          }
        }

        lines.push(currentLine);
        return lines;
      }

      // å¤åˆ¶åˆ°å‰ªè´´æ¿
      async function copyToClipboard(dataUrl) {
        try {
          // å°† dataUrl è½¬æ¢ä¸º Blob
          const response = await fetch(dataUrl);
          const blob = await response.blob();

          // ä½¿ç”¨ Clipboard API å¤åˆ¶å›¾ç‰‡
          await navigator.clipboard.write([
            new ClipboardItem({
              [blob.type]: blob
            })
          ]);

          showMessage("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿", "success");
        } catch (err) {
          // å¦‚æœå‰ªè´´æ¿ API å¤±è´¥ï¼Œå°è¯•ä¼ ç»Ÿæ–¹æ³•
          console.error("å¤åˆ¶å¤±è´¥:", err);
          showMessage("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶", "error");
        }
      }

      // ä¸‹è½½å›¾ç‰‡
      function downloadImage(dataUrl, filename) {
        const link = document.createElement("a");
        link.href = dataUrl;
        link.download = filename;
        link.click();
        showMessage("å·²å¼€å§‹ä¸‹è½½", "success");
      }

      // æ˜¾ç¤ºæ¶ˆæ¯
      function showToast(message, type = "success") {
        showMessage(message, type);
      }

      function showMessage(message, type) {
        // æˆåŠŸæ¶ˆæ¯ä½¿ç”¨æ›´çŸ­çš„æ˜¾ç¤ºæ—¶é—´ï¼Œé”™è¯¯æ¶ˆæ¯ä¿æŒè¾ƒé•¿æ—¶é—´
        const displayTime = type === "success" ? 2000 : 3000;

        // æ›´æ–°toastå†…å®¹å’Œæ ·å¼
        const toastDiv = document.getElementById("toast");
        toastDiv.textContent = message;
        toastDiv.className = "toast toast-" + type;

        // æ˜¾ç¤ºtoast
        setTimeout(() => {
          toastDiv.classList.add("show");

          // è®¾ç½®è‡ªåŠ¨éšè—
          setTimeout(() => {
            toastDiv.classList.remove("show");
          }, displayTime);
        }, 10);
      }

      // ç”Ÿæˆéšæœºç¾è§‚æ¸å˜é¢œè‰²
      function generateRandomGradientColors() {
        // é¢„å®šä¹‰çš„ç¾è§‚è‰²è°ƒèŒƒå›´
        // é¢„å®šä¹‰çš„ç¾è§‚è‰²è°ƒèŒƒå›´ï¼Œå‚è€ƒå¾®ä¿¡è“ã€å¾®ä¿¡ç»¿ã€æš–è‰²è°ƒç­‰
        const presetGradients = [
          // å¾®ä¿¡è“ (æ¥è¿‘)
          {
            h1: [200, 220],
            s1: [70, 90],
            l1: [50, 70],
            h2: [200, 220],
            s2: [50, 70],
            l2: [70, 90],
          },
          // å¾®ä¿¡ç»¿ (æ¥è¿‘)
          {
            h1: [140, 160],
            s1: [70, 90],
            l1: [40, 60],
            h2: [140, 160],
            s2: [50, 70],
            l2: [60, 80],
          },
          // æš–è‰²è°ƒ (æ¥è¿‘)
          {
            h1: [30, 50],
            s1: [80, 100],
            l1: [50, 70],
            h2: [10, 30],
            s2: [70, 90],
            l2: [60, 80],
          },
          // æŸ”å’Œè“ç´«
          {
            h1: [240, 260],
            s1: [50, 70],
            l1: [60, 80],
            h2: [270, 290],
            s2: [40, 60],
            l2: [70, 90],
          },
          // æ¸…æ–°ç»¿é»„
          {
            h1: [80, 100],
            s1: [60, 80],
            l1: [50, 70],
            h2: [60, 80],
            s2: [50, 70],
            l2: [60, 80],
          },
          // æ´»åŠ›æ©™çº¢
          {
            h1: [0, 20],
            s1: [80, 100],
            l1: [50, 70],
            h2: [330, 350],
            s2: [70, 90],
            l2: [60, 80],
          },
          // æµªæ¼«ç´«ç²‰
          {
            h1: [280, 310],
            s1: [60, 80],
            l1: [60, 80],
            h2: [320, 350],
            s2: [70, 90],
            l2: [70, 90],
          },
          // æ·±æµ·è“é’
          {
            h1: [190, 210],
            s1: [70, 90],
            l1: [40, 60],
            h2: [170, 190],
            s2: [60, 80],
            l2: [50, 70],
          },
          // é‡‘ç§‹é»„æ£•
          {
            h1: [35, 55],
            s1: [70, 90],
            l1: [50, 70],
            h2: [25, 45],
            s2: [60, 80],
            l2: [40, 60],
          },
          // è–„è·ç»¿é’
          {
            h1: [150, 170],
            s1: [50, 70],
            l1: [60, 80],
            h2: [180, 200],
            s2: [60, 80],
            l2: [70, 90],
          },
          // æ˜Ÿç©ºç´«è“
          {
            h1: [230, 250],
            s1: [70, 90],
            l1: [40, 60],
            h2: [260, 280],
            s2: [50, 70],
            l2: [50, 70],
          },
          // çŠç‘šç²‰æ©™
          {
            h1: [350, 10],
            s1: [80, 100],
            l1: [60, 80],
            h2: [20, 40],
            s2: [80, 100],
            l2: [60, 80],
          },
          // æ£®æ—ç»¿
          {
            h1: [100, 130],
            s1: [50, 70],
            l1: [30, 50],
            h2: [140, 160],
            s2: [50, 70],
            l2: [40, 60],
          },
          // å†°å·è“
          {
            h1: [195, 215],
            s1: [80, 100],
            l1: [70, 90],
            h2: [200, 220],
            s2: [60, 80],
            l2: [80, 95],
          },
          // æ—¥è½æ©™ç´«
          {
            h1: [25, 45],
            s1: [80, 100],
            l1: [55, 75],
            h2: [270, 290],
            s2: [40, 60],
            l2: [50, 70],
          },
          // ç³–æœç²‰ç´«
          {
            h1: [300, 320],
            s1: [70, 90],
            l1: [70, 90],
            h2: [330, 350],
            s2: [80, 100],
            l2: [75, 95],
          },
          // æ¹–æ°´è“ç»¿
          {
            h1: [165, 185],
            s1: [60, 80],
            l1: [55, 75],
            h2: [175, 195],
            s2: [70, 90],
            l2: [65, 85],
          },
        ];

        // éšæœºé€‰æ‹©ä¸€ä¸ªé¢„è®¾æ¸å˜
        const selectedPreset =
          presetGradients[Math.floor(Math.random() * presetGradients.length)];

        // åœ¨é€‰å®šçš„èŒƒå›´å†…ç”Ÿæˆéšæœºè‰²è°ƒã€é¥±å’Œåº¦å’Œäº®åº¦
        const hue1 =
          Math.floor(
            Math.random() * (selectedPreset.h1[1] - selectedPreset.h1[0])
          ) + selectedPreset.h1[0];
        const saturation1 =
          Math.floor(
            Math.random() * (selectedPreset.s1[1] - selectedPreset.s1[0])
          ) + selectedPreset.s1[0];
        const lightness1 =
          Math.floor(
            Math.random() * (selectedPreset.l1[1] - selectedPreset.l1[0])
          ) + selectedPreset.l1[0];

        const hue2 =
          Math.floor(
            Math.random() * (selectedPreset.h2[1] - selectedPreset.h2[0])
          ) + selectedPreset.h2[0];
        const saturation2 =
          Math.floor(
            Math.random() * (selectedPreset.s2[1] - selectedPreset.s2[0])
          ) + selectedPreset.s2[0];
        const lightness2 =
          Math.floor(
            Math.random() * (selectedPreset.l2[1] - selectedPreset.l2[0])
          ) + selectedPreset.l2[0];

        // å°†HSLè½¬æ¢ä¸ºRGBï¼Œç„¶åè½¬æ¢ä¸ºåå…­è¿›åˆ¶é¢œè‰²ä»£ç 
        const color1 = hslToHex(hue1, saturation1, lightness1);
        const color2 = hslToHex(hue2, saturation2, lightness2);

        return {
          primary: color1,
          secondary: color2,
        };
      }

      // HSLé¢œè‰²è½¬æ¢ä¸ºåå…­è¿›åˆ¶é¢œè‰²ä»£ç 
      function hslToHex(h, s, l) {
        // å°†é¥±å’Œåº¦å’Œäº®åº¦è½¬æ¢ä¸º0-1èŒƒå›´
        s /= 100;
        l /= 100;

        const c = (1 - Math.abs(2 * l - 1)) * s;
        const x = c * (1 - Math.abs(((h / 60) % 2) - 1));
        const m = l - c / 2;

        let r, g, b;

        if (h >= 0 && h < 60) {
          r = c;
          g = x;
          b = 0;
        } else if (h >= 60 && h < 120) {
          r = x;
          g = c;
          b = 0;
        } else if (h >= 120 && h < 180) {
          r = 0;
          g = c;
          b = x;
        } else if (h >= 180 && h < 240) {
          r = 0;
          g = x;
          b = c;
        } else if (h >= 240 && h < 300) {
          r = x;
          g = 0;
          b = c;
        } else {
          r = c;
          g = 0;
          b = x;
        }

        // å°†RGBå€¼è½¬æ¢ä¸º0-255èŒƒå›´ï¼Œç„¶åè½¬æ¢ä¸ºåå…­è¿›åˆ¶
        r = Math.round((r + m) * 255);
        g = Math.round((g + m) * 255);
        b = Math.round((b + m) * 255);

        // è½¬æ¢ä¸ºåå…­è¿›åˆ¶é¢œè‰²ä»£ç 
        return `#${r.toString(16).padStart(2, "0")}${g
          .toString(16)
          .padStart(2, "0")}${b.toString(16).padStart(2, "0")}`;
      }

      // æå–å›¾ç‰‡ä¸»ä½“é¢œè‰²å‡½æ•° - é€‰æ‹©æœ€é²œäº®çš„é¢œè‰²ï¼Œæ’é™¤é»‘è‰²å’Œç™½è‰²
      function extractDominantColors(image) {
        // åˆ›å»ºä¸€ä¸ªä¸´æ—¶ç”»å¸ƒæ¥åˆ†æå›¾ç‰‡é¢œè‰²
        const tempCanvas = document.createElement("canvas");
        const tempCtx = tempCanvas.getContext("2d");

        // è®¾ç½®è¾ƒå°çš„å°ºå¯¸ä»¥æé«˜æ€§èƒ½
        const size = 100; // å¢åŠ å°ºå¯¸ä»¥è·å–æ›´å¤šé¢œè‰²æ ·æœ¬
        tempCanvas.width = size;
        tempCanvas.height = size;

        // åœ¨ä¸´æ—¶ç”»å¸ƒä¸Šç»˜åˆ¶å›¾ç‰‡
        tempCtx.drawImage(image, 0, 0, size, size);

        // è·å–å›¾ç‰‡æ•°æ®
        const imageData = tempCtx.getImageData(0, 0, size, size).data;

        // ç”¨äºå­˜å‚¨é¢œè‰²ä¿¡æ¯
        const colorInfo = [];

        // åˆ†ææ¯ä¸ªåƒç´ 
        for (let i = 0; i < imageData.length; i += 4) {
          const r = imageData[i];
          const g = imageData[i + 1];
          const b = imageData[i + 2];
          const a = imageData[i + 3];

          // å¿½ç•¥é€æ˜åƒç´ 
          if (a < 128) continue;

          // å°†RGBå€¼é‡åŒ–ä¸ºæ›´å°‘çš„é¢œè‰²ï¼Œä»¥ä¾¿æ›´å¥½åœ°åˆ†ç»„
          const quantizedR = Math.round(r / 24) * 24;
          const quantizedG = Math.round(g / 24) * 24;
          const quantizedB = Math.round(b / 24) * 24;

          // è®¡ç®—é¢œè‰²çš„äº®åº¦ (0-255)
          const brightness =
            (quantizedR * 299 + quantizedG * 587 + quantizedB * 114) / 1000;

          // è®¡ç®—é¢œè‰²çš„é¥±å’Œåº¦ (0-1)
          const max = Math.max(quantizedR, quantizedG, quantizedB);
          const min = Math.min(quantizedR, quantizedG, quantizedB);
          let saturation = 0;
          if (max !== 0) {
            saturation = (max - min) / max;
          }

          // è®¡ç®—é¢œè‰²çš„é²œè‰³åº¦ (é¥±å’Œåº¦ * äº®åº¦çš„é€‚ä¸­å€¼)
          // äº®åº¦å¤ªä½æˆ–å¤ªé«˜çš„é¢œè‰²éƒ½ä¸å¤Ÿé²œè‰³
          const brightnessWeight = 1 - Math.abs((brightness - 128) / 128);
          const vividness = saturation * brightnessWeight;

          // æ’é™¤æ¥è¿‘é»‘è‰²å’Œç™½è‰²çš„é¢œè‰²
          // é»‘è‰²: äº®åº¦å¾ˆä½
          // ç™½è‰²: äº®åº¦å¾ˆé«˜ä¸”é¥±å’Œåº¦å¾ˆä½
          const isBlack = brightness < 40;
          const isWhite = brightness > 200 && saturation < 0.2;

          if (!isBlack && !isWhite) {
            const colorKey = `${quantizedR},${quantizedG},${quantizedB}`;

            // å­˜å‚¨é¢œè‰²ä¿¡æ¯ï¼ŒåŒ…æ‹¬RGBå€¼ã€é²œè‰³åº¦å’Œå‡ºç°æ¬¡æ•°
            colorInfo.push({
              key: colorKey,
              r: quantizedR,
              g: quantizedG,
              b: quantizedB,
              vividness: vividness,
              count: 1,
            });
          }
        }

        // åˆå¹¶ç›¸åŒé¢œè‰²å¹¶è®¡ç®—æ€»æ•°
        const colorMap = {};
        colorInfo.forEach((info) => {
          if (colorMap[info.key]) {
            colorMap[info.key].count += info.count;
          } else {
            colorMap[info.key] = info;
          }
        });

        // å°†é¢œè‰²è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
        // é¦–å…ˆæŒ‰é²œè‰³åº¦æ’åºï¼Œç„¶åæŒ‰å‡ºç°æ¬¡æ•°æ’åº
        const sortedColors = Object.values(colorMap).sort((a, b) => {
          // é²œè‰³åº¦æƒé‡ (70%) + å‡ºç°é¢‘ç‡æƒé‡ (30%)
          const aScore = a.vividness * 0.7 + (a.count / colorInfo.length) * 0.3;
          const bScore = b.vividness * 0.7 + (b.count / colorInfo.length) * 0.3;
          return bScore - aScore;
        });

        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„é¢œè‰²ï¼Œè¿”å›é»˜è®¤é¢œè‰²
        if (sortedColors.length === 0) {
          return {
            primary: "#D5E7FB",
            secondary: "#9EBEFA",
          };
        }

        // è·å–æœ€é²œè‰³çš„é¢œè‰²ä½œä¸ºä¸»è‰²è°ƒ
        const primaryColor = `#${sortedColors[0].r
          .toString(16)
          .padStart(2, "0")}${sortedColors[0].g
          .toString(16)
          .padStart(2, "0")}${sortedColors[0].b.toString(16).padStart(2, "0")}`;

        // ç”Ÿæˆæ¬¡è¦é¢œè‰² - å¯ä»¥æ˜¯ä¸»è‰²è°ƒçš„äº’è¡¥è‰²æˆ–å˜ä½“
        let secondaryColor;

        // åˆ¤æ–­ä¸»è‰²è°ƒçš„äº®åº¦
        const primaryBrightness =
          (sortedColors[0].r * 299 +
            sortedColors[0].g * 587 +
            sortedColors[0].b * 114) /
          1000;

        if (primaryBrightness > 128) {
          // å¦‚æœä¸»è‰²è°ƒè¾ƒäº®ï¼Œç”Ÿæˆè¾ƒæš—çš„æ¬¡è¦é¢œè‰²
          const darkerR = Math.max(0, sortedColors[0].r - 60);
          const darkerG = Math.max(0, sortedColors[0].g - 60);
          const darkerB = Math.max(0, sortedColors[0].b - 60);
          secondaryColor = `#${darkerR.toString(16).padStart(2, "0")}${darkerG
            .toString(16)
            .padStart(2, "0")}${darkerB.toString(16).padStart(2, "0")}`;
        } else {
          // å¦‚æœä¸»è‰²è°ƒè¾ƒæš—ï¼Œç”Ÿæˆè¾ƒäº®çš„æ¬¡è¦é¢œè‰²
          const lighterR = Math.min(255, sortedColors[0].r + 60);
          const lighterG = Math.min(255, sortedColors[0].g + 60);
          const lighterB = Math.min(255, sortedColors[0].b + 60);
          secondaryColor = `#${lighterR.toString(16).padStart(2, "0")}${lighterG
            .toString(16)
            .padStart(2, "0")}${lighterB.toString(16).padStart(2, "0")}`;
        }

        return {
          primary: primaryColor,
          secondary: secondaryColor,
        };
      }

      // éšæœºæ¸å˜æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
      const randomGradientBtn = document.getElementById("randomGradientBtn");
      randomGradientBtn.addEventListener("click", function () {
        const randomColors = generateRandomGradientColors();
        bgColor1Input.value = randomColors.primary;
        bgColor1Value.textContent = randomColors.primary;
        bgColor2Input.value = randomColors.secondary;
        bgColor2Value.textContent = randomColors.secondary;

        const directions = [
          "to right",
          "to bottom",
          "to right bottom",
          "to left bottom",
        ];
        const randomDirection =
          directions[Math.floor(Math.random() * directions.length)];
        gradientTypeSelect.value = randomDirection;

        const radius = Math.floor(Math.random() * 16); // 0-15çš„åœ†è§’
        cardRadiusInput.value = radius.toString();
        cardRadiusValue.textContent = radius.toString();

        const shadow = 3 + Math.floor(Math.random() * 8); // 3-10çš„é˜´å½±
        cardShadowInput.value = shadow.toString();
        cardShadowValue.textContent = shadow.toString();

        showMessage("å·²ç”Ÿæˆéšæœºç¾è§‚æ¸å˜èƒŒæ™¯", "success");
      });

      // å¾®ä¿¡æ ·å¼é¢„è®¾
      stylePresetSelect.addEventListener("change", function () {
        const preset = stylePresetSelect.value;

        switch (preset) {
          case "random":
            // éšæœºç¾è§‚æ¸å˜
            const randomColors = generateRandomGradientColors();
            bgColor1Input.value = randomColors.primary;
            bgColor1Value.textContent = randomColors.primary;
            bgColor2Input.value = randomColors.secondary;
            bgColor2Value.textContent = randomColors.secondary;

            // éšæœºé€‰æ‹©æ¸å˜æ–¹å‘
            const directions = [
              "to right",
              "to bottom",
              "to right bottom",
              "to left bottom",
            ];
            const randomDirection =
              directions[Math.floor(Math.random() * directions.length)];
            gradientTypeSelect.value = randomDirection;

            // éšæœºè®¾ç½®åœ†è§’å’Œé˜´å½±
            const radius = Math.floor(Math.random() * 16); // 0-15çš„åœ†è§’
            cardRadiusInput.value = radius.toString();
            cardRadiusValue.textContent = radius.toString();

            const shadow = 3 + Math.floor(Math.random() * 8); // 3-10çš„é˜´å½±
            cardShadowInput.value = shadow.toString();
            cardShadowValue.textContent = shadow.toString();

            showMessage("å·²ç”Ÿæˆéšæœºç¾è§‚æ¸å˜èƒŒæ™¯", "success");
            break;
          case "auto":
            // è‡ªåŠ¨æ¨¡å¼ - éœ€è¦æ£€æŸ¥æ˜¯å¦å·²ä¸Šä¼ ä¸»å›¾ç‰‡
            if (mainImageUploadInput.files && mainImageUploadInput.files.length > 0) {
              // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
              loadingDiv.classList.add("show");

              // åŠ è½½å›¾ç‰‡å¹¶æå–é¢œè‰²
              const img = new Image();
              img.onload = function () {
                // æå–ä¸»ä½“é¢œè‰²
                const colors = extractDominantColors(img);

                // åº”ç”¨æå–çš„é¢œè‰²
                bgColor1Input.value = colors.primary;
                bgColor1Value.textContent = colors.primary;
                bgColor2Input.value = colors.secondary;
                bgColor2Value.textContent = colors.secondary;

                // è®¾ç½®æ¸å˜æ–¹å‘ - å¯¹è§’çº¿é€šå¸¸æ•ˆæœè¾ƒå¥½
                gradientTypeSelect.value = "to right bottom";

                // éšè—åŠ è½½æŒ‡ç¤ºå™¨
                loadingDiv.classList.remove("show");

                showMessage(
                  "å·²æ ¹æ®å›¾ç‰‡æœ€é²œè‰³çš„é¢œè‰²è‡ªåŠ¨è®¾ç½®èƒŒæ™¯æ¸å˜",
                  "success"
                );
              };

              img.onerror = function () {
                // åŠ è½½å¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤é¢œè‰²
                bgColor1Input.value = "#D5E7FB";
                bgColor1Value.textContent = "#D5E7FB";
                bgColor2Input.value = "#9EBEFA";
                bgColor2Value.textContent = "#9EBEFA";

                loadingDiv.classList.remove("show");
                showMessage("æ— æ³•åˆ†æå›¾ç‰‡é¢œè‰²ï¼Œå·²ä½¿ç”¨é»˜è®¤é¢œè‰²", "error");
              };

              img.src = URL.createObjectURL(mainImageUploadInput.files[0]);
            } else {
              showMessage("è¯·å…ˆä¸Šä¼ ä¸»å›¾ç‰‡ï¼Œå†ä½¿ç”¨è‡ªåŠ¨é¢œè‰²åŠŸèƒ½", "error");
              // é‡ç½®ä¸ºé»˜è®¤æ ·å¼
              stylePresetSelect.value = "default";

              // åº”ç”¨é»˜è®¤æ ·å¼
              bgColor1Input.value = "#D5E7FB";
              bgColor1Value.textContent = "#D5E7FB";
              bgColor2Input.value = "#9EBEFA";
              bgColor2Value.textContent = "#9EBEFA";
              gradientTypeSelect.value = "to right";
              cardRadiusInput.value = "0";
              cardRadiusValue.textContent = "0";
              cardShadowInput.value = "5";
              cardShadowValue.textContent = "5";
            }
            break;
          case "wechat-blue":
            // å¾®ä¿¡è“è‰²è°ƒ
            bgColor1Input.value = "#1E90FF";
            bgColor1Value.textContent = "#1E90FF";
            bgColor2Input.value = "#87CEFA";
            bgColor2Value.textContent = "#87CEFA";
            gradientTypeSelect.value = "to right bottom";
            cardRadiusInput.value = "0";
            cardRadiusValue.textContent = "0";
            cardShadowInput.value = "8";
            cardShadowValue.textContent = "8";
            break;
          case "wechat-green":
            // å¾®ä¿¡ç»¿è‰²è°ƒ
            bgColor1Input.value = "#07C160";
            bgColor1Value.textContent = "#07C160";
            bgColor2Input.value = "#A0E6C8";
            bgColor2Value.textContent = "#A0E6C8";
            gradientTypeSelect.value = "to bottom";
            cardRadiusInput.value = "0";
            cardRadiusValue.textContent = "0";
            cardShadowInput.value = "6";
            cardShadowValue.textContent = "6";
            break;
          case "elegant":
            // ç®€çº¦é£æ ¼
            bgColor1Input.value = "#F5F5F5";
            bgColor1Value.textContent = "#F5F5F5";
            bgColor2Input.value = "#E0E0E0";
            bgColor2Value.textContent = "#E0E0E0";
            gradientTypeSelect.value = "to right";
            cardRadiusInput.value = "0";
            cardRadiusValue.textContent = "0";
            cardShadowInput.value = "3";
            cardShadowValue.textContent = "3";
            break;
          case "warm":
            // æš–è‰²è°ƒ
            bgColor1Input.value = "#FFD700";
            bgColor1Value.textContent = "#FFD700";
            bgColor2Input.value = "#FFA07A";
            bgColor2Value.textContent = "#FFA07A";
            gradientTypeSelect.value = "to right bottom";
            cardRadiusInput.value = "0";
            cardRadiusValue.textContent = "0";
            cardShadowInput.value = "10";
            cardShadowValue.textContent = "10";
            break;
          case "cool":
            // å†·è‰²è°ƒ
            bgColor1Input.value = "#4B0082";
            bgColor1Value.textContent = "#4B0082";
            bgColor2Input.value = "#9370DB";
            bgColor2Value.textContent = "#9370DB";
            gradientTypeSelect.value = "to bottom";
            cardRadiusInput.value = "0";
            cardRadiusValue.textContent = "0";
            cardShadowInput.value = "7";
            cardShadowValue.textContent = "7";
            break;
          case "custom":
            // è‡ªå®šä¹‰æ ·å¼ï¼Œä¸åšä»»ä½•æ”¹å˜
            break;
          case "default":
          default:
            // é»˜è®¤æ ·å¼
            bgColor1Input.value = "#D5E7FB";
            bgColor1Value.textContent = "#D5E7FB";
            bgColor2Input.value = "#9EBEFA";
            bgColor2Value.textContent = "#9EBEFA";
            gradientTypeSelect.value = "to right";
            cardRadiusInput.value = "0";
            cardRadiusValue.textContent = "0";
            cardShadowInput.value = "5";
            cardShadowValue.textContent = "5";
            break;
        }
      });

      // ç»˜åˆ¶æ°´å°
      function drawWatermark() {
        const watermarkText =
          watermarkTextInput.value.trim() || "å…¬ä¼—å·:ç§‘æŠ€ç ”ä¹ å®¤";
        const watermarkColor = watermarkColorInput.value;
        const watermarkOpacity = parseInt(watermarkOpacityInput.value) / 100;
        const watermarkSize = parseInt(watermarkSizeInput.value);
        const watermarkPosition = watermarkPositionSelect.value;

        ctx.save();
        ctx.font = `${watermarkSize}px Arial`;
        ctx.fillStyle = hexToRgba(watermarkColor, watermarkOpacity);
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";

        if (watermarkPosition === "tile") {
          // å¹³é“ºæ°´å°
          const textWidth = ctx.measureText(watermarkText).width;
          const textHeight = watermarkSize;
          const horizontalSpacing = textWidth * 2.5; // æ°´å¹³é—´è·
          const verticalSpacing = textHeight * 8; // å‚ç›´é—´è·

          ctx.translate(canvas.width / 2, canvas.height / 2);
          ctx.rotate(-Math.PI / 6); // æ—‹è½¬-30åº¦
          ctx.translate(-canvas.width / 2, -canvas.height / 2);

          for (
            let y = -canvas.height;
            y < canvas.height * 2;
            y += verticalSpacing
          ) {
            for (
              let x = -canvas.width;
              x < canvas.width * 2;
              x += horizontalSpacing
            ) {
              ctx.fillText(watermarkText, x, y);
            }
          }
        } else {
          // å•ä¸ªæ°´å°
          let x, y;
          const padding = 20; // è¾¹ç¼˜å†…è¾¹è·
          const textWidth = ctx.measureText(watermarkText).width;
          const textHeight = watermarkSize;

          switch (watermarkPosition) {
            case "bottom-right":
              x = canvas.width - textWidth / 2 - padding;
              y = canvas.height - textHeight / 2 - padding;
              break;
            case "bottom-left":
              x = textWidth / 2 + padding;
              y = canvas.height - textHeight / 2 - padding;
              break;
            case "top-right":
              x = canvas.width - textWidth / 2 - padding;
              y = textHeight / 2 + padding;
              break;
            case "top-left":
              x = textWidth / 2 + padding;
              y = textHeight / 2 + padding;
              break;
            case "center":
              x = canvas.width / 2;
              y = canvas.height / 2;
              break;
          }
          ctx.fillText(watermarkText, x, y);
        }

        ctx.restore();
      }

      // å°†åå…­è¿›åˆ¶é¢œè‰²è½¬æ¢ä¸ºå¸¦é€æ˜åº¦çš„rgba
      function hexToRgba(hex, alpha) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
      }

      // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", function () {
        // åªè§¦å‘æ ·å¼é¢„è®¾çš„changeäº‹ä»¶ï¼Œåº”ç”¨éšæœºæ ·å¼
        // ä¸å†è°ƒç”¨resetForm()ï¼Œé¿å…é‡å¤ç”Ÿæˆéšæœºé¢œè‰²å¯¼è‡´é¢œè‰²ç›¸åŒ
        const event = new Event("change");
        stylePresetSelect.dispatchEvent(event);
        // éšè—æ¶ˆæ¯
        toastDiv.classList.remove("show");
      });

      // é‡ç½®è¡¨å•
      function resetForm() {
        // é‡ç½®æ–‡ä»¶è¾“å…¥
        mainImageUploadInput.value = "";
        qrCodeImageUploadInput.value = "";
        mainImageFiles = [];
        qrCodeImageFiles = [];
        mainImagePreviewContainer.innerHTML = "";
        qrCodeImagePreviewContainer.innerHTML = "";

        // é‡ç½®å…¶ä»–è¾“å…¥å­—æ®µ
        cardTitleInput.value = "";
        fontFamilySelect.value = "Arial";
        textColorInput.value = "#000000";
        textColorValue.textContent = "#000000";
        textSizeInput.value = "24";
        textSizeValue.textContent = "24";
        textShadowInput.value = "0";
        textShadowValue.textContent = "0";
        stylePresetSelect.value = "random";

        // é‡æ–°ç”Ÿæˆéšæœºæ ·å¼
        const randomColors = generateRandomGradientColors();
        bgColor1Input.value = randomColors.primary;
        bgColor1Value.textContent = randomColors.primary;
        bgColor2Input.value = randomColors.secondary;
        bgColor2Value.textContent = randomColors.secondary;
        const directions = [
          "to right",
          "to bottom",
          "to right bottom",
          "to left bottom",
        ];
        gradientTypeSelect.value =
          directions[Math.floor(Math.random() * directions.length)];
        cardRadiusInput.value = Math.floor(Math.random() * 16).toString();
        cardShadowInput.value = (3 + Math.floor(Math.random() * 8)).toString();

        // é‡ç½®æ°´å°è®¾ç½®
        enableWatermarkInput.checked = true;
        watermarkTextInput.value = "å…¬ä¼—å·:ç§‘æŠ€ç ”ä¹ å®¤";
        watermarkColorInput.value = "#000000";
        watermarkColorValue.textContent = "#000000";
        watermarkOpacityInput.value = "30";
        watermarkOpacityValue.textContent = "30";
        watermarkSizeInput.value = "16";
        watermarkSizeValue.textContent = "16";
        watermarkPositionSelect.value = "tile";

        // iPhoneå¥—å£³åŠŸèƒ½å·²ç§»åˆ°ç‹¬ç«‹tabï¼Œæ— éœ€é‡ç½®

        // é‡ç½®é¢„è§ˆ
        cardPreviewContainer.innerHTML = "";
        downloadBtn.disabled = true;

        // éšè—æ¶ˆæ¯
        toastDiv.classList.remove("show");

        showMessage("å·²é‡ç½®æ‰€æœ‰è®¾ç½®", "success");
      }

      // æ¨¡æ€æ¡†é€»è¾‘
      const modal = document.getElementById("imageModal");
      const modalImg = document.getElementById("modalImage");
      const closeBtn = document.querySelector(".close-btn");

      function openModal(src) {
        modal.style.display = "block";
        modalImg.src = src;
      }

      closeBtn.onclick = function () {
        modal.style.display = "none";
      };

      window.onclick = function (event) {
        if (event.target == modal) {
          modal.style.display = "none";
        }
      };

      // ESCé”®å…³é—­æ¨¡æ€æ¡†
      document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape' && modal.style.display === 'block') {
          modal.style.display = 'none';
        }
      });
    </script>
  </body>
</html>
