<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>图片卡片生成器</title>
    <!-- 使用SVG作为现代浏览器的favicon -->
    <link rel="icon" href="favicon.svg" type="image/svg+xml" />
    <!-- 为了兼容旧浏览器，可以使用以下工具将SVG转换为ICO或PNG: https://convertio.co/svg-ico/ -->
    <link rel="shortcut icon" href="favicon.svg" type="image/svg+xml" />
    <!-- 如需更好的兼容性，建议添加以下几种尺寸的图标：
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    -->
    <style>
      :root {
        --primary-color: #07C160; /* 微信绿 */
        --secondary-color: #10AEFF; /* 微信蓝 */
        --light-color: #f8f9fa;
        --dark-color: #343a40;
        --success-color: #07C160; /* 微信绿 */
        --danger-color: #FA5151; /* 微信红 */
        --warning-color: #FF9F0F; /* 微信橙 */
        --bg-color1: #D9F7BE; /* 浅绿渐变 */
        --bg-color2: #B5F5EC; /* 浅蓝渐变 */
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        font-family: "Helvetica Neue", Arial, sans-serif;
        line-height: 1.6;
        color: #333;
        background-color: #f5f5f5;
        margin: 0;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background-color: #fff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      }

      h1 {
        text-align: center;
        margin-bottom: 30px;
        color: #333;
      }
      .title {
        display: flex;
        justify-content: center;
        align-items: center;
      }

      /* 两列布局样式 */
      .main-content {
        display: flex;
        flex-direction: row;
        gap: 30px;
        margin-bottom: 20px;
      }

      .settings-column {
        flex: 0 0 40%;
        max-width: 40%;
      }

      .preview-column {
        flex: 0 0 60%;
        max-width: 60%;
        position: sticky;
        top: 20px;
        align-self: flex-start;
      }

      /* 面板样式调整 */
      .panels {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .panel {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        padding: 20px;
        margin-bottom: 0;
      }

      .panels {
        display: flex;
        flex-direction: column;
        gap: 20px;
        width: 100%;
      }

      .panel {
        width: 100%;
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
      }

      .panel-title {
        font-size: 1.2rem;
        margin-bottom: 15px;
        color: var(--primary-color);
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 5px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
      }

      input[type="text"],
      input[type="file"],
      select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
      }

      input[type="color"] {
        width: 50px;
        height: 30px;
        padding: 2px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .color-picker {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .slider-container {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .slider-value {
        min-width: 30px;
        text-align: center;
      }

      input[type="range"] {
        flex: 1;
      }

      .btn {
        display: inline-block;
        padding: 10px 20px;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        transition: background-color 0.3s;
      }

      .btn:hover {
        background-color: var(--secondary-color);
      }

      .btn-danger {
        background-color: var(--danger-color);
      }

      .btn-danger:hover {
        background-color: #c82333;
      }

      .btn-group {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-bottom: 20px;
      }

      .preview-container {
        text-align: center;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        padding: 20px;
        position: sticky;
        top: 20px;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .preview-title {
        margin-bottom: 20px;
        font-weight: 500;
        font-size: 1.2rem;
        color: var(--primary-color);
      }

      #cardPreview {
        max-width: 100%;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        display: none;
        margin-bottom: 20px;
      }

      .card-preview-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        width: 100%;
        margin-bottom: 20px;
      }

      .preview-item {
        position: relative;
      }

      .preview-item img {
        width: 100%;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        cursor: pointer; /* 添加手型光标 */
      }

      /* 模态框样式 */
      .modal {
        display: none; 
        position: fixed; 
        z-index: 1001; 
        padding-top: 60px; 
        left: 0;
        top: 0;
        width: 100%; 
        height: 100%; 
        overflow: auto; 
        background-color: rgba(0,0,0,0.9);
      }

      .modal-content {
        margin: auto;
        display: block;
        max-width: 90%;
        max-height: 85vh; /* 限制最大高度为视窗高度的85% */
      }

      .close-btn {
        position: absolute;
        top: 15px;
        right: 35px;
        color: #f1f1f1;
        font-size: 40px;
        font-weight: bold;
        transition: 0.3s;
        cursor: pointer;
      }

      .close-btn:hover,
      .close-btn:focus {
        color: #bbb;
        text-decoration: none;
        cursor: pointer;
      }

      .preview-item .download-btn {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        padding: 5px 10px;
        font-size: 0.8rem;
        background-color: var(--primary-color);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        opacity: 0.8;
        transition: opacity 0.3s;
      }

      .preview-item:hover .download-btn {
        opacity: 1;
      }

      /* 预览区域的按钮组 */
      .preview-btn-group {
        display: flex;
        gap: 15px;
        margin-top: 20px;
        justify-content: center;
      }

      /* 水印样式 */
      .watermark-container {
        margin-top: 15px;
      }

      .watermark-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .watermark-toggle {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(255, 255, 255, 0.9);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        text-align: center;
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .loading.show {
        opacity: 1;
        display: block;
      }

      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top: 4px solid var(--primary-color);
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .toast {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 24px;
        border-radius: 4px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
      }

      .toast.show {
        opacity: 1;
      }

      .toast-success {
        background-color: #d4edda;
        color: #155724;
        border-left: 4px solid #28a745;
        font-weight: 500;
      }

      .toast-error {
        background-color: #f8d7da;
        color: #721c24;
        border-left: 4px solid #dc3545;
        font-weight: 500;
      }

      .image-preview-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
      }

      .image-preview {
        max-width: 100%;
        max-height: 150px;
        display: block;
        border-radius: 4px;
      }

      .font-option {
        padding: 5px;
        font-family: inherit;
      }

      .font-arial {
        font-family: Arial, sans-serif;
      }
      .font-times {
        font-family: "Times New Roman", serif;
      }
      .font-courier {
        font-family: "Courier New", monospace;
      }
      .font-georgia {
        font-family: Georgia, serif;
      }
      .font-verdana {
        font-family: Verdana, sans-serif;
      }
      .font-palatino {
        font-family: "Palatino Linotype", "Book Antiqua", serif;
      }

      @media (max-width: 1024px) {
        .main-content {
          flex-direction: column;
        }

        .settings-column,
        .preview-column {
          flex: 0 0 100%;
          max-width: 100%;
        }

        .preview-column {
          position: static;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="title">
        <img
          src="logo.svg"
          alt="网站Logo"
          style="height: 36px; vertical-align: middle; margin-right: 10px"
        />图片卡片生成器
      </h1>

      <div class="main-content">
        <!-- 左侧设置区域 -->
        <div class="settings-column">
          <div class="panels">
            <div class="panel">
              <h2 class="panel-title">上传图片</h2>

              <div class="form-group">
                <label for="mainImageUpload">上传多张主图片</label>
                <input type="file" id="mainImageUpload" accept="image/*" multiple />
                <div id="mainImagePreviewContainer" class="image-preview-container"></div>
              </div>
              <div class="form-group">
                <label for="qrCodeImageUpload">上传多个二维码</label>
                <input type="file" id="qrCodeImageUpload" accept="image/*" multiple />
                <div id="qrCodeImagePreviewContainer" class="image-preview-container"></div>
              </div>
            </div>

            <div class="panel">
              <h2 class="panel-title">样式设置</h2>

              <div class="form-group">
                <label for="stylePreset">微信样式预设</label>
                <select id="stylePreset">
                  <option value="random" selected>随机(生成美观渐变)</option>
                  <option value="auto">自动(提取图片最鲜艳颜色)</option>
                  <option value="default">默认样式</option>
                  <option value="wechat-blue">微信蓝</option>
                  <option value="wechat-green">微信绿</option>
                  <option value="elegant">简约风格</option>
                  <option value="warm">暖色调</option>
                  <option value="cool">冷色调</option>
                  <option value="custom">自定义</option>
                </select>
              </div>

              <div class="form-group">
                <button id="randomGradientBtn" class="btn">随机渐变</button>
              </div>

              <div class="form-group">
                <label for="bgColor1">背景颜色 1</label>
                <div class="color-picker">
                  <input type="color" id="bgColor1" value="#D5E7FB" />
                  <span id="bgColor1Value">#D5E7FB</span>
                </div>
              </div>

              <div class="form-group">
                <label for="bgColor2">背景颜色 2</label>
                <div class="color-picker">
                  <input type="color" id="bgColor2" value="#9EBEFA" />
                  <span id="bgColor2Value">#9EBEFA</span>
                </div>
              </div>

              <div class="form-group">
                <label for="gradientType">渐变方向</label>
                <select id="gradientType">
                  <option value="to right">水平</option>
                  <option value="to bottom">垂直</option>
                  <option value="to right bottom">对角线</option>
                  <option value="circle">径向</option>
                </select>
              </div>

              <div class="form-group">
                <label for="cardPadding">内边距</label>
                <div class="slider-container">
                  <input
                    type="range"
                    id="cardPadding"
                    min="0"
                    max="50"
                    value="0"
                  />
                  <span class="slider-value" id="cardPaddingValue">0</span>
                </div>
              </div>

              <div class="form-group">
                <label for="cardRadius">圆角半径</label>
                <div class="slider-container">
                  <input
                    type="range"
                    id="cardRadius"
                    min="0"
                    max="50"
                    value="0"
                  />
                  <span class="slider-value" id="cardRadiusValue">0</span>
                </div>
              </div>

              <div class="form-group">
                <label for="cardShadow">阴影强度</label>
                <div class="slider-container">
                  <input
                    type="range"
                    id="cardShadow"
                    min="0"
                    max="20"
                    value="5"
                  />
                  <span class="slider-value" id="cardShadowValue">5</span>
                </div>
              </div>
            </div>

            <div class="panel">
              <h2 class="panel-title">文字设置</h2>

              <div class="form-group">
                <label for="cardTitle">卡片标题</label>
                <input
                  type="text"
                  id="cardTitle"
                  placeholder="输入卡片标题"
                  maxlength="100"
                />
              </div>

              <div class="form-group">
                <label for="fontFamily">字体</label>
                <select id="fontFamily">
                  <option value="Arial" class="font-option font-arial">
                    Arial
                  </option>
                  <option
                    value="Times New Roman"
                    class="font-option font-times"
                  >
                    Times New Roman
                  </option>
                  <option value="Courier New" class="font-option font-courier">
                    Courier New
                  </option>
                  <option value="Georgia" class="font-option font-georgia">
                    Georgia
                  </option>
                  <option value="Verdana" class="font-option font-verdana">
                    Verdana
                  </option>
                  <option
                    value="Palatino Linotype"
                    class="font-option font-palatino"
                  >
                    Palatino
                  </option>
                </select>
              </div>

              <div class="form-group">
                <label for="textColor">文字颜色</label>
                <div class="color-picker">
                  <input type="color" id="textColor" value="#000000" />
                  <span id="textColorValue">#000000</span>
                </div>
              </div>

              <div class="form-group">
                <label for="textSize">文字大小</label>
                <div class="slider-container">
                  <input
                    type="range"
                    id="textSize"
                    min="10"
                    max="50"
                    value="24"
                  />
                  <span class="slider-value" id="textSizeValue">24</span>
                </div>
              </div>

              <div class="form-group">
                <label for="textShadow">文字阴影</label>
                <div class="slider-container">
                  <input
                    type="range"
                    id="textShadow"
                    min="0"
                    max="10"
                    value="0"
                  />
                  <span class="slider-value" id="textShadowValue">0</span>
                </div>
              </div>
            </div>

            <div class="panel">
              <h2 class="panel-title">水印设置</h2>

              <div class="form-group watermark-toggle">
                <input type="checkbox" id="enableWatermark" checked />
                <label for="enableWatermark">启用水印</label>
              </div>

              <div class="watermark-group">
                <div class="form-group">
                  <label for="watermarkText">水印文字</label>
                  <input
                    type="text"
                    id="watermarkText"
                    placeholder="输入水印文字"
                    value="公众号:科技研习室"
                  />
                </div>

                <div class="form-group">
                  <label for="watermarkColor">水印颜色</label>
                  <div class="color-picker">
                    <input type="color" id="watermarkColor" value="#000000" />
                    <span id="watermarkColorValue">#000000</span>
                  </div>
                </div>

                <div class="form-group">
                  <label for="watermarkOpacity">水印透明度</label>
                  <div class="slider-container">
                    <input
                      type="range"
                      id="watermarkOpacity"
                      min="0"
                      max="100"
                      value="30"
                    />
                    <span class="slider-value" id="watermarkOpacityValue"
                      >30</span
                    >
                  </div>
                </div>

                <div class="form-group">
                  <label for="watermarkSize">水印大小</label>
                  <div class="slider-container">
                    <input
                      type="range"
                      id="watermarkSize"
                      min="10"
                      max="30"
                      value="16"
                    />
                    <span class="slider-value" id="watermarkSizeValue">16</span>
                  </div>
                </div>

                <div class="form-group">
                  <label for="watermarkPosition">水印位置</label>
                  <select id="watermarkPosition">
                    <option value="bottom-right">右下角</option>
                    <option value="bottom-left">左下角</option>
                    <option value="top-right">右上角</option>
                    <option value="top-left">左上角</option>
                    <option value="center">居中</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- 移除左侧底部的重置按钮 -->
          </div>
        </div>

        <!-- 右侧预览区域 -->
        <div class="preview-column">
          <div class="preview-container">
            <h3 class="preview-title">卡片预览</h3>
            <div id="cardPreviewContainer" class="card-preview-grid"></div>

            <!-- 生成、下载和重置按钮放在右侧预览区域 -->
            <div class="preview-btn-group">
              <button id="generateBtn" class="btn">生成卡片</button>
              <button id="downloadBtn" class="btn" disabled>下载卡片</button>
              <button id="resetBtn" class="btn btn-danger">重置设置</button>
            </div>
          </div>
        </div>
      </div>

      <div id="imageModal" class="modal">
        <span class="close-btn">&times;</span>
        <img class="modal-content" id="modalImage">
      </div>

      <div class="loading">
        <div class="spinner"></div>
        <p>正在生成卡片...</p>
      </div>

      <div id="toast" class="toast"></div>

      <canvas id="canvas" style="display: none"></canvas>
    </div>

    <script>
      // DOM元素
      const mainImageUploadInput = document.getElementById("mainImageUpload");
      const qrCodeImageUploadInput = document.getElementById("qrCodeImageUpload");
      const mainImagePreviewContainer = document.getElementById("mainImagePreviewContainer");
      const qrCodeImagePreviewContainer = document.getElementById("qrCodeImagePreviewContainer");
      const cardTitleInput = document.getElementById("cardTitle");
      const fontFamilySelect = document.getElementById("fontFamily");
      const textColorInput = document.getElementById("textColor");
      const textColorValue = document.getElementById("textColorValue");
      const textSizeInput = document.getElementById("textSize");
      const textSizeValue = document.getElementById("textSizeValue");
      const textShadowInput = document.getElementById("textShadow");
      const textShadowValue = document.getElementById("textShadowValue");
      const stylePresetSelect = document.getElementById("stylePreset");
      const bgColor1Input = document.getElementById("bgColor1");
      const bgColor1Value = document.getElementById("bgColor1Value");
      const bgColor2Input = document.getElementById("bgColor2");
      const bgColor2Value = document.getElementById("bgColor2Value");
      const gradientTypeSelect = document.getElementById("gradientType");
      const cardPaddingInput = document.getElementById("cardPadding");
      const cardPaddingValue = document.getElementById("cardPaddingValue");
      const cardRadiusInput = document.getElementById("cardRadius");
      const cardRadiusValue = document.getElementById("cardRadiusValue");
      const cardShadowInput = document.getElementById("cardShadow");
      const cardShadowValue = document.getElementById("cardShadowValue");
      // 水印相关元素
      const enableWatermarkInput = document.getElementById("enableWatermark");
      const watermarkTextInput = document.getElementById("watermarkText");
      const watermarkColorInput = document.getElementById("watermarkColor");
      const watermarkColorValue = document.getElementById(
        "watermarkColorValue"
      );
      const watermarkOpacityInput = document.getElementById("watermarkOpacity");
      const watermarkOpacityValue = document.getElementById(
        "watermarkOpacityValue"
      );
      const watermarkSizeInput = document.getElementById("watermarkSize");
      const watermarkSizeValue = document.getElementById("watermarkSizeValue");
      const watermarkPositionSelect =
        document.getElementById("watermarkPosition");
      const generateBtn = document.getElementById("generateBtn");
      const downloadBtn = document.getElementById("downloadBtn");
      const resetBtn = document.getElementById("resetBtn");
      const loadingDiv = document.querySelector(".loading");
      const toastDiv = document.getElementById("toast");
      const cardPreviewContainer = document.getElementById("cardPreviewContainer");
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");

      // Helper function for natural sorting of filenames
      function naturalSortComparer(a, b) {
        // Extract numbers, default to 1 if not found (for cases like 'image.png')
        const numA = parseInt(a.name.match(/\d+/)?.[0] || '1');
        const numB = parseInt(b.name.match(/\d+/)?.[0] || '1');

        // If numbers are different, sort by number
        if (numA !== numB) {
          return numA - numB;
        }

        // If numbers are the same (or both are 1), sort by the full name as a fallback
        return a.name.localeCompare(b.name);
      }

      let mainImageFiles = [];
      let qrCodeImageFiles = [];

      mainImageUploadInput.addEventListener("change", (e) => {
        mainImageFiles = Array.from(e.target.files).sort(naturalSortComparer);
        updatePreview(mainImagePreviewContainer, mainImageFiles);
      });

      qrCodeImageUploadInput.addEventListener("change", (e) => {
        qrCodeImageFiles = Array.from(e.target.files).sort(naturalSortComparer);
        updatePreview(qrCodeImagePreviewContainer, qrCodeImageFiles);
      });

      function updatePreview(container, files) {
        container.innerHTML = ""; // 清空现有预览
        files.forEach(file => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = document.createElement("img");
            img.src = e.target.result;
            img.classList.add("image-preview");
            container.appendChild(img);
          };
          reader.readAsDataURL(file);
        });
      }

      // 颜色选择器值显示
      textColorInput.addEventListener("input", function () {
        textColorValue.textContent = textColorInput.value;
      });

      bgColor1Input.addEventListener("input", function () {
        bgColor1Value.textContent = bgColor1Input.value;
      });

      bgColor2Input.addEventListener("input", function () {
        bgColor2Value.textContent = bgColor2Input.value;
      });

      // 水印颜色选择器值显示
      watermarkColorInput.addEventListener("input", function () {
        watermarkColorValue.textContent = watermarkColorInput.value;
      });

      // 滑块值显示
      textSizeInput.addEventListener("input", function () {
        textSizeValue.textContent = textSizeInput.value;
      });

      textShadowInput.addEventListener("input", function () {
        textShadowValue.textContent = textShadowInput.value;
      });

      cardPaddingInput.addEventListener("input", function () {
        cardPaddingValue.textContent = cardPaddingInput.value;
      });

      cardRadiusInput.addEventListener("input", function () {
        cardRadiusValue.textContent = cardRadiusInput.value;
      });

      cardShadowInput.addEventListener("input", function () {
        cardShadowValue.textContent = cardShadowInput.value;
      });

      // 水印滑块值显示
      watermarkOpacityInput.addEventListener("input", function () {
        watermarkOpacityValue.textContent = watermarkOpacityInput.value;
      });

      watermarkSizeInput.addEventListener("input", function () {
        watermarkSizeValue.textContent = watermarkSizeInput.value;
      });

      // 生成卡片
      generateBtn.addEventListener("click", function (e) {
        e.preventDefault();
        generateCard();
      });

      // 下载卡片
      downloadBtn.style.display = 'none'; // 隐藏全局下载按钮

      // 重置表单
      resetBtn.addEventListener("click", resetForm);

      // 加载图片函数
      function loadImage(file, previewElement) {
        if (!file) {
          previewElement.src = "";
          previewElement.style.display = "none";
          return;
        }

        // 验证图片类型
        const validTypes = [
          "image/jpeg",
          "image/png",
          "image/gif",
          "image/webp",
        ];
        if (!validTypes.includes(file.type)) {
          showMessage("请上传有效的图片文件 (JPEG, PNG, GIF, WEBP)", "error");
          previewElement.src = "";
          previewElement.style.display = "none";
          return;
        }

        // 验证图片大小 (最大5MB)
        if (file.size > 5 * 1024 * 1024) {
          showMessage("图片大小不能超过5MB", "error");
          previewElement.src = "";
          previewElement.style.display = "none";
          return;
        }

        const reader = new FileReader();
        reader.onload = function (e) {
          previewElement.src = e.target.result;
          previewElement.style.display = "block";
        };
        reader.readAsDataURL(file);
      }

      // 生成卡片函数
      async function generateCard() {
        if (mainImageFiles.length === 0) {
          showMessage("请至少上传一张主图片", "error");
          return;
        }

        loadingDiv.classList.add("show");
        cardPreviewContainer.innerHTML = ""; // 清空预览
        downloadBtn.disabled = true;

        const pairings = Math.min(mainImageFiles.length, qrCodeImageFiles.length);

        try {
          for (let i = 0; i < mainImageFiles.length; i++) {
            const mainImageFile = mainImageFiles[i];
            const qrCodeFile = i < pairings ? qrCodeImageFiles[i] : null;

            const mainImage = await loadImageAsync(URL.createObjectURL(mainImageFile));
            const qrCodeImage = qrCodeFile ? await loadImageAsync(URL.createObjectURL(qrCodeFile)) : null;

            // 设置画布尺寸
            const cardWidth = 900;
            const cardHeight = 900;
            canvas.width = cardWidth;
            canvas.height = cardHeight;

            // 绘制背景
            drawBackground();

            // 绘制卡片内容
            const padding = parseInt(cardPaddingInput.value);
            const radius = parseInt(cardRadiusInput.value);
            const shadow = parseInt(cardShadowInput.value);
            drawCardArea(padding, radius, shadow);

            const contentWidth = cardWidth - 2 * padding;
            const contentHeight = cardHeight - 2 * padding;
            const spacing = contentWidth * 0.1;

            // 绘制主图片
            const mainImageRatio = mainImage.width / mainImage.height;
            let mainImageHeight, mainImageWidth, mainImageX, mainImageY;

            if (qrCodeImage) {
              mainImageHeight = contentHeight * 0.9;
              mainImageWidth = mainImageHeight * mainImageRatio;
              if (mainImageWidth > contentWidth * 0.65) {
                mainImageWidth = contentWidth * 0.65;
                mainImageHeight = mainImageWidth / mainImageRatio;
              }
              mainImageX = padding + spacing;
              mainImageY = padding + (contentHeight - mainImageHeight) / 2;
            } else {
              mainImageHeight = contentHeight * 0.95;
              mainImageWidth = mainImageHeight * mainImageRatio;
              if (mainImageWidth > contentWidth * 0.9) {
                mainImageWidth = contentWidth * 0.9;
                mainImageHeight = mainImageWidth / mainImageRatio;
              }
              mainImageX = padding + (contentWidth - mainImageWidth) / 2;
              mainImageY = padding + (contentHeight - mainImageHeight) / 2;
            }
            ctx.drawImage(mainImage, mainImageX, mainImageY, mainImageWidth, mainImageHeight);

            // 绘制二维码
            if (qrCodeImage) {
              const qrCodeSize = Math.min(contentWidth * 0.3, Math.min(qrCodeImage.width, qrCodeImage.height));
              const qrCodeX = padding + contentWidth - spacing - qrCodeSize - 10;
              const qrCodeY = padding + (contentHeight - qrCodeSize) / 2;
              ctx.fillStyle = "white";
              ctx.fillRect(qrCodeX - 5, qrCodeY - 5, qrCodeSize + 10, qrCodeSize + 10);
              ctx.drawImage(qrCodeImage, qrCodeX, qrCodeY, qrCodeSize, qrCodeSize);
            }

            // 绘制标题
            if (cardTitleInput.value.trim()) {
                const text = cardTitleInput.value.trim();
                const fontSize = parseInt(textSizeInput.value);
                const fontFamily = fontFamilySelect.value;
                const textColor = textColorInput.value;
                const textShadow = parseInt(textShadowInput.value);

                ctx.font = `bold ${fontSize}px ${fontFamily}`;
                ctx.textAlign = "center";
                ctx.textBaseline = "top";

                if (textShadow > 0) {
                    ctx.shadowColor = "rgba(0, 0, 0, 0.5)";
                    ctx.shadowBlur = textShadow;
                    ctx.shadowOffsetX = textShadow / 2;
                    ctx.shadowOffsetY = textShadow / 2;
                }

                const lines = wrapTextImproved(ctx, text, contentWidth - 60, fontSize);
                const lineHeight = fontSize * 1.3;
                const totalTextHeight = lines.length * lineHeight;
                const textX = cardWidth / 2;
                let textY = padding + 15;

                const textBgPadding = 10;
                const textBgWidth = contentWidth - 40;
                const textBgHeight = totalTextHeight + textBgPadding * 2;
                const textBgX = (cardWidth - textBgWidth) / 2;
                const textBgY = textY - textBgPadding;

                ctx.fillStyle = "rgba(255, 255, 255, 0.7)";
                roundRect(ctx, textBgX, textBgY, textBgWidth, textBgHeight, 5, true, false);

                ctx.fillStyle = textColor;
                for (let j = 0; j < lines.length; j++) {
                    ctx.fillText(lines[j], textX, textY + j * lineHeight);
                }

                ctx.shadowColor = "transparent";
                ctx.shadowBlur = 0;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;
            }

            // 绘制水印
            if (enableWatermarkInput.checked) {
              drawWatermark();
            }

            // 创建预览项
            const dataUrl = canvas.toDataURL("image/png");
            const previewItem = document.createElement("div");
            previewItem.classList.add("preview-item");

            const img = document.createElement("img");
            img.src = dataUrl;
            img.onclick = () => openModal(dataUrl);

            const downloadButton = document.createElement("button");
            downloadButton.textContent = "下载";
            downloadButton.classList.add("download-btn");
            downloadButton.onclick = () => {
                const link = document.createElement("a");
                const mainImageName = mainImageFile.name.split('.').slice(0, -1).join('.');
                link.download = `${mainImageName}_card.png`;
                link.href = dataUrl;
                link.click();
            };

            previewItem.appendChild(img);
            previewItem.appendChild(downloadButton);
            cardPreviewContainer.appendChild(previewItem);
          }

          showMessage(`成功生成 ${mainImageFiles.length} 张卡片!`, "success");
        } catch (error) {
          console.error("生成卡片出错:", error);
          showMessage("生成卡片时出错: " + error.message, "error");
        } finally {
          loadingDiv.classList.remove("show");
        }
      }

      // 异步加载图片
      function loadImageAsync(src) {
        return new Promise((resolve, reject) => {
          if (!src) {
            resolve(null);
            return;
          }

          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = () => reject(new Error("图片加载失败"));
          img.src = src;
        });
      }

      // 绘制背景
      function drawBackground() {
        let bgColor1 = bgColor1Input.value;
        let bgColor2 = bgColor2Input.value;
        const gradientType = gradientTypeSelect.value;

        // 验证颜色值是否有效，如果无效则使用默认值
        if (!/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(bgColor1)) {
          bgColor1 = "#D5E7FB"; // 默认颜色1
        }
        if (!/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(bgColor2)) {
          bgColor2 = "#9EBEFA"; // 默认颜色2
        }

        let gradient;

        if (gradientType === "circle") {
          // 径向渐变
          gradient = ctx.createRadialGradient(
            canvas.width / 2,
            canvas.height / 2,
            0,
            canvas.width / 2,
            canvas.height / 2,
            Math.max(canvas.width, canvas.height) / 2
          );
        } else {
          // 线性渐变
          let x0, y0, x1, y1;

          switch (gradientType) {
            case "to right":
              x0 = 0;
              y0 = 0;
              x1 = canvas.width;
              y1 = 0;
              break;
            case "to bottom":
              x0 = 0;
              y0 = 0;
              x1 = 0;
              y1 = canvas.height;
              break;
            case "to right bottom":
              x0 = 0;
              y0 = 0;
              x1 = canvas.width;
              y1 = canvas.height;
              break;
          }

          // 确保渐变坐标是有限的数字
          if (!isFinite(x0) || !isFinite(y0) || !isFinite(x1) || !isFinite(y1)) {
            console.warn("Gradient coordinates are non-finite, using fallback.");
            x0 = 0; y0 = 0; x1 = canvas.width; y1 = canvas.height; // Fallback to a safe gradient
          }

          gradient = ctx.createLinearGradient(x0, y0, x1, y1);
        }

        gradient.addColorStop(0, bgColor1);
        gradient.addColorStop(1, bgColor2);

        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }

      // 绘制卡片区域
      function drawCardArea(padding, radius, shadow) {
        const x = padding;
        const y = padding;
        const width = canvas.width - 2 * padding;
        const height = canvas.height - 2 * padding;

        // 确保圆角半径不超过卡片尺寸的限制
        radius = Math.min(radius, Math.min(width / 2, height / 2));

        // 保存当前绘图状态
        ctx.save();

        // 绘制阴影
        if (shadow > 0) {
          ctx.shadowColor = "rgba(0, 0, 0, 0.3)";
          ctx.shadowBlur = shadow;
          ctx.shadowOffsetX = shadow / 2;
          ctx.shadowOffsetY = shadow / 2;
        }

        // 绘制圆角矩形
        roundRect(ctx, x, y, width, height, radius, true, false);

        // 不填充白色背景，保留渐变背景
        // ctx.fillStyle = "white";
        // ctx.fill();

        // 重置阴影
        ctx.shadowColor = "transparent";
        ctx.shadowBlur = 0;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 0;

        // 恢复绘图状态
        ctx.restore();
      }

      // 绘制圆角矩形 - 改进版，使用arcTo方法更精确地绘制圆角
      function roundRect(ctx, x, y, width, height, radius, fill, stroke) {
        // 确保半径不超过宽度和高度的一半
        radius = Math.min(radius, Math.min(width / 2, height / 2));

        ctx.beginPath();

        // 从左上角开始，顺时针绘制
        ctx.moveTo(x + radius, y);

        // 上边
        ctx.lineTo(x + width - radius, y);
        // 右上角
        ctx.arcTo(x + width, y, x + width, y + radius, radius);

        // 右边
        ctx.lineTo(x + width, y + height - radius);
        // 右下角
        ctx.arcTo(
          x + width,
          y + height,
          x + width - radius,
          y + height,
          radius
        );

        // 下边
        ctx.lineTo(x + radius, y + height);
        // 左下角
        ctx.arcTo(x, y + height, x, y + height - radius, radius);

        // 左边
        ctx.lineTo(x, y + radius);
        // 左上角
        ctx.arcTo(x, y, x + radius, y, radius);

        ctx.closePath();

        if (fill) {
          ctx.fill();
        }
        if (stroke) {
          ctx.stroke();
        }
      }

      // 优化的文字换行函数 - 支持中文和英文
      function wrapTextImproved(context, text, maxWidth, fontSize) {
        // 检测是否包含中文字符
        const containsChinese = /[\u4e00-\u9fa5]/.test(text);

        if (containsChinese) {
          // 中文文本处理 - 按字符分割
          return wrapChineseText(context, text, maxWidth);
        } else {
          // 英文文本处理 - 按单词分割
          return wrapEnglishText(context, text, maxWidth);
        }
      }

      // 中文文本换行
      function wrapChineseText(context, text, maxWidth) {
        const lines = [];
        let currentLine = "";

        // 逐字符检查
        for (let i = 0; i < text.length; i++) {
          const char = text[i];
          const testLine = currentLine + char;
          const metrics = context.measureText(testLine);
          const testWidth = metrics.width;

          if (testWidth > maxWidth && currentLine !== "") {
            lines.push(currentLine);
            currentLine = char;
          } else {
            currentLine = testLine;
          }
        }

        // 添加最后一行
        if (currentLine !== "") {
          lines.push(currentLine);
        }

        return lines;
      }

      // 英文文本换行
      function wrapEnglishText(context, text, maxWidth) {
        const words = text.split(" ");
        const lines = [];
        let currentLine = words[0];

        for (let i = 1; i < words.length; i++) {
          const word = words[i];
          const width = context.measureText(currentLine + " " + word).width;

          if (width < maxWidth) {
            currentLine += " " + word;
          } else {
            lines.push(currentLine);
            currentLine = word;
          }
        }

        lines.push(currentLine);
        return lines;
      }

      // 显示消息
      function showMessage(message, type) {
        // 成功消息使用更短的显示时间，错误消息保持较长时间
        const displayTime = type === "success" ? 2000 : 3000;

        // 更新toast内容和样式
        const toastDiv = document.getElementById("toast");
        toastDiv.textContent = message;
        toastDiv.className = "toast toast-" + type;

        // 显示toast
        setTimeout(() => {
          toastDiv.classList.add("show");

          // 设置自动隐藏
          setTimeout(() => {
            toastDiv.classList.remove("show");
          }, displayTime);
        }, 10);
      }

      // 生成随机美观渐变颜色
      function generateRandomGradientColors() {
        // 预定义的美观色调范围
        // 预定义的美观色调范围，参考微信蓝、微信绿、暖色调等
        const presetGradients = [
          // 微信蓝 (接近)
          { h1: [200, 220], s1: [70, 90], l1: [50, 70], h2: [200, 220], s2: [50, 70], l2: [70, 90] },
          // 微信绿 (接近)
          { h1: [140, 160], s1: [70, 90], l1: [40, 60], h2: [140, 160], s2: [50, 70], l2: [60, 80] },
          // 暖色调 (接近)
          { h1: [30, 50], s1: [80, 100], l1: [50, 70], h2: [10, 30], s2: [70, 90], l2: [60, 80] },
          // 柔和蓝紫
          { h1: [240, 260], s1: [50, 70], l1: [60, 80], h2: [270, 290], s2: [40, 60], l2: [70, 90] },
          // 清新绿黄
          { h1: [80, 100], s1: [60, 80], l1: [50, 70], h2: [60, 80], s2: [50, 70], l2: [60, 80] },
          // 活力橙红
          { h1: [0, 20], s1: [80, 100], l1: [50, 70], h2: [330, 350], s2: [70, 90], l2: [60, 80] }
        ];
        
        // 随机选择一个预设渐变
        const selectedPreset = presetGradients[Math.floor(Math.random() * presetGradients.length)];
        
        // 在选定的范围内生成随机色调、饱和度和亮度
        const hue1 = Math.floor(Math.random() * (selectedPreset.h1[1] - selectedPreset.h1[0])) + selectedPreset.h1[0];
        const saturation1 = Math.floor(Math.random() * (selectedPreset.s1[1] - selectedPreset.s1[0])) + selectedPreset.s1[0];
        const lightness1 = Math.floor(Math.random() * (selectedPreset.l1[1] - selectedPreset.l1[0])) + selectedPreset.l1[0];
        
        const hue2 = Math.floor(Math.random() * (selectedPreset.h2[1] - selectedPreset.h2[0])) + selectedPreset.h2[0];
        const saturation2 = Math.floor(Math.random() * (selectedPreset.s2[1] - selectedPreset.s2[0])) + selectedPreset.s2[0];
        const lightness2 = Math.floor(Math.random() * (selectedPreset.l2[1] - selectedPreset.l2[0])) + selectedPreset.l2[0];
        
        // 将HSL转换为RGB，然后转换为十六进制颜色代码
        const color1 = hslToHex(hue1, saturation1, lightness1);
        const color2 = hslToHex(hue2, saturation2, lightness2);
        
        return {
          primary: color1,
          secondary: color2
        };
      }
      
      // HSL颜色转换为十六进制颜色代码
      function hslToHex(h, s, l) {
        // 将饱和度和亮度转换为0-1范围
        s /= 100;
        l /= 100;
        
        const c = (1 - Math.abs(2 * l - 1)) * s;
        const x = c * (1 - Math.abs((h / 60) % 2 - 1));
        const m = l - c / 2;
        
        let r, g, b;
        
        if (h >= 0 && h < 60) {
          r = c; g = x; b = 0;
        } else if (h >= 60 && h < 120) {
          r = x; g = c; b = 0;
        } else if (h >= 120 && h < 180) {
          r = 0; g = c; b = x;
        } else if (h >= 180 && h < 240) {
          r = 0; g = x; b = c;
        } else if (h >= 240 && h < 300) {
          r = x; g = 0; b = c;
        } else {
          r = c; g = 0; b = x;
        }
        
        // 将RGB值转换为0-255范围，然后转换为十六进制
        r = Math.round((r + m) * 255);
        g = Math.round((g + m) * 255);
        b = Math.round((b + m) * 255);
        
        // 转换为十六进制颜色代码
        return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
      }
      
      // 提取图片主体颜色函数 - 选择最鲜亮的颜色，排除黑色和白色
      function extractDominantColors(image) {
        // 创建一个临时画布来分析图片颜色
        const tempCanvas = document.createElement('canvas');
        const tempCtx = tempCanvas.getContext('2d');
        
        // 设置较小的尺寸以提高性能
        const size = 100; // 增加尺寸以获取更多颜色样本
        tempCanvas.width = size;
        tempCanvas.height = size;
        
        // 在临时画布上绘制图片
        tempCtx.drawImage(image, 0, 0, size, size);
        
        // 获取图片数据
        const imageData = tempCtx.getImageData(0, 0, size, size).data;
        
        // 用于存储颜色信息
        const colorInfo = [];
        
        // 分析每个像素
        for (let i = 0; i < imageData.length; i += 4) {
          const r = imageData[i];
          const g = imageData[i + 1];
          const b = imageData[i + 2];
          const a = imageData[i + 3];
          
          // 忽略透明像素
          if (a < 128) continue;
          
          // 将RGB值量化为更少的颜色，以便更好地分组
          const quantizedR = Math.round(r / 24) * 24;
          const quantizedG = Math.round(g / 24) * 24;
          const quantizedB = Math.round(b / 24) * 24;
          
          // 计算颜色的亮度 (0-255)
          const brightness = (quantizedR * 299 + quantizedG * 587 + quantizedB * 114) / 1000;
          
          // 计算颜色的饱和度 (0-1)
          const max = Math.max(quantizedR, quantizedG, quantizedB);
          const min = Math.min(quantizedR, quantizedG, quantizedB);
          let saturation = 0;
          if (max !== 0) {
            saturation = (max - min) / max;
          }
          
          // 计算颜色的鲜艳度 (饱和度 * 亮度的适中值)
          // 亮度太低或太高的颜色都不够鲜艳
          const brightnessWeight = 1 - Math.abs((brightness - 128) / 128);
          const vividness = saturation * brightnessWeight;
          
          // 排除接近黑色和白色的颜色
          // 黑色: 亮度很低
          // 白色: 亮度很高且饱和度很低
          const isBlack = brightness < 40;
          const isWhite = brightness > 200 && saturation < 0.2;
          
          if (!isBlack && !isWhite) {
            const colorKey = `${quantizedR},${quantizedG},${quantizedB}`;
            
            // 存储颜色信息，包括RGB值、鲜艳度和出现次数
            colorInfo.push({
              key: colorKey,
              r: quantizedR,
              g: quantizedG,
              b: quantizedB,
              vividness: vividness,
              count: 1
            });
          }
        }
        
        // 合并相同颜色并计算总数
        const colorMap = {};
        colorInfo.forEach(info => {
          if (colorMap[info.key]) {
            colorMap[info.key].count += info.count;
          } else {
            colorMap[info.key] = info;
          }
        });
        
        // 将颜色转换为数组并排序
        // 首先按鲜艳度排序，然后按出现次数排序
        const sortedColors = Object.values(colorMap).sort((a, b) => {
          // 鲜艳度权重 (70%) + 出现频率权重 (30%)
          const aScore = a.vividness * 0.7 + (a.count / colorInfo.length) * 0.3;
          const bScore = b.vividness * 0.7 + (b.count / colorInfo.length) * 0.3;
          return bScore - aScore;
        });
        
        // 如果没有找到合适的颜色，返回默认颜色
        if (sortedColors.length === 0) {
          return {
            primary: '#D5E7FB',
            secondary: '#9EBEFA'
          };
        }
        
        // 获取最鲜艳的颜色作为主色调
        const primaryColor = `#${sortedColors[0].r.toString(16).padStart(2, '0')}${sortedColors[0].g.toString(16).padStart(2, '0')}${sortedColors[0].b.toString(16).padStart(2, '0')}`;
        
        // 生成次要颜色 - 可以是主色调的互补色或变体
        let secondaryColor;
        
        // 判断主色调的亮度
        const primaryBrightness = (sortedColors[0].r * 299 + sortedColors[0].g * 587 + sortedColors[0].b * 114) / 1000;
        
        if (primaryBrightness > 128) {
          // 如果主色调较亮，生成较暗的次要颜色
          const darkerR = Math.max(0, sortedColors[0].r - 60);
          const darkerG = Math.max(0, sortedColors[0].g - 60);
          const darkerB = Math.max(0, sortedColors[0].b - 60);
          secondaryColor = `#${darkerR.toString(16).padStart(2, '0')}${darkerG.toString(16).padStart(2, '0')}${darkerB.toString(16).padStart(2, '0')}`;
        } else {
          // 如果主色调较暗，生成较亮的次要颜色
          const lighterR = Math.min(255, sortedColors[0].r + 60);
          const lighterG = Math.min(255, sortedColors[0].g + 60);
          const lighterB = Math.min(255, sortedColors[0].b + 60);
          secondaryColor = `#${lighterR.toString(16).padStart(2, '0')}${lighterG.toString(16).padStart(2, '0')}${lighterB.toString(16).padStart(2, '0')}`;
        }
        
        return {
          primary: primaryColor,
          secondary: secondaryColor
        };
      }
      
      // 随机渐变按钮事件监听器
      const randomGradientBtn = document.getElementById("randomGradientBtn");
      randomGradientBtn.addEventListener("click", function() {
        const randomColors = generateRandomGradientColors();
        bgColor1Input.value = randomColors.primary;
        bgColor1Value.textContent = randomColors.primary;
        bgColor2Input.value = randomColors.secondary;
        bgColor2Value.textContent = randomColors.secondary;

        const directions = ["to right", "to bottom", "to right bottom", "to left bottom"];
        const randomDirection = directions[Math.floor(Math.random() * directions.length)];
        gradientTypeSelect.value = randomDirection;

        const radius = Math.floor(Math.random() * 16); // 0-15的圆角
        cardRadiusInput.value = radius.toString();
        cardRadiusValue.textContent = radius.toString();

        const shadow = 3 + Math.floor(Math.random() * 8); // 3-10的阴影
        cardShadowInput.value = shadow.toString();
        cardShadowValue.textContent = shadow.toString();

        showMessage("已生成随机美观渐变背景", "success");
      });

      // 微信样式预设
      stylePresetSelect.addEventListener("change", function () {
        const preset = stylePresetSelect.value;

        switch (preset) {
          case "random":
            // 随机美观渐变
            const randomColors = generateRandomGradientColors();
            bgColor1Input.value = randomColors.primary;
            bgColor1Value.textContent = randomColors.primary;
            bgColor2Input.value = randomColors.secondary;
            bgColor2Value.textContent = randomColors.secondary;
            
            // 随机选择渐变方向
            const directions = ["to right", "to bottom", "to right bottom", "to left bottom"];
            const randomDirection = directions[Math.floor(Math.random() * directions.length)];
            gradientTypeSelect.value = randomDirection;
            
            // 随机设置圆角和阴影
            const radius = Math.floor(Math.random() * 16); // 0-15的圆角
            cardRadiusInput.value = radius.toString();
            cardRadiusValue.textContent = radius.toString();
            
            const shadow = 3 + Math.floor(Math.random() * 8); // 3-10的阴影
            cardShadowInput.value = shadow.toString();
            cardShadowValue.textContent = shadow.toString();
            
            showMessage("已生成随机美观渐变背景", "success");
            break;
          case "auto":
            // 自动模式 - 需要检查是否已上传主图片
            if (mainImageInput.files && mainImageInput.files.length > 0) {
              // 显示加载指示器
              loadingDiv.classList.add("show");
              
              // 加载图片并提取颜色
              const img = new Image();
              img.onload = function() {
                // 提取主体颜色
                const colors = extractDominantColors(img);
                
                // 应用提取的颜色
                bgColor1Input.value = colors.primary;
                bgColor1Value.textContent = colors.primary;
                bgColor2Input.value = colors.secondary;
                bgColor2Value.textContent = colors.secondary;
                
                // 设置渐变方向 - 对角线通常效果较好
                gradientTypeSelect.value = "to right bottom";
                
                // 隐藏加载指示器
                loadingDiv.classList.remove("show");
                
                showMessage("已根据图片最鲜艳的颜色自动设置背景渐变", "success");
              };
              
              img.onerror = function() {
                // 加载失败时使用默认颜色
                bgColor1Input.value = "#D5E7FB";
                bgColor1Value.textContent = "#D5E7FB";
                bgColor2Input.value = "#9EBEFA";
                bgColor2Value.textContent = "#9EBEFA";
                
                loadingDiv.classList.remove("show");
                showMessage("无法分析图片颜色，已使用默认颜色", "error");
              };
              
              img.src = URL.createObjectURL(mainImageInput.files[0]);
            } else {
              showMessage("请先上传主图片，再使用自动颜色功能", "error");
              // 重置为默认样式
              stylePresetSelect.value = "default";
              
              // 应用默认样式
              bgColor1Input.value = "#D5E7FB";
              bgColor1Value.textContent = "#D5E7FB";
              bgColor2Input.value = "#9EBEFA";
              bgColor2Value.textContent = "#9EBEFA";
              gradientTypeSelect.value = "to right";
              cardRadiusInput.value = "0";
              cardRadiusValue.textContent = "0";
              cardShadowInput.value = "5";
              cardShadowValue.textContent = "5";
            }
            break;
          case "wechat-blue":
            // 微信蓝色调
            bgColor1Input.value = "#1E90FF";
            bgColor1Value.textContent = "#1E90FF";
            bgColor2Input.value = "#87CEFA";
            bgColor2Value.textContent = "#87CEFA";
            gradientTypeSelect.value = "to right bottom";
            cardRadiusInput.value = "0";
            cardRadiusValue.textContent = "0";
            cardShadowInput.value = "8";
            cardShadowValue.textContent = "8";
            break;
          case "wechat-green":
            // 微信绿色调
            bgColor1Input.value = "#07C160";
            bgColor1Value.textContent = "#07C160";
            bgColor2Input.value = "#A0E6C8";
            bgColor2Value.textContent = "#A0E6C8";
            gradientTypeSelect.value = "to bottom";
            cardRadiusInput.value = "0";
            cardRadiusValue.textContent = "0";
            cardShadowInput.value = "6";
            cardShadowValue.textContent = "6";
            break;
          case "elegant":
            // 简约风格
            bgColor1Input.value = "#F5F5F5";
            bgColor1Value.textContent = "#F5F5F5";
            bgColor2Input.value = "#E0E0E0";
            bgColor2Value.textContent = "#E0E0E0";
            gradientTypeSelect.value = "to right";
            cardRadiusInput.value = "0";
            cardRadiusValue.textContent = "0";
            cardShadowInput.value = "3";
            cardShadowValue.textContent = "3";
            break;
          case "warm":
            // 暖色调
            bgColor1Input.value = "#FFD700";
            bgColor1Value.textContent = "#FFD700";
            bgColor2Input.value = "#FFA07A";
            bgColor2Value.textContent = "#FFA07A";
            gradientTypeSelect.value = "to right bottom";
            cardRadiusInput.value = "0";
            cardRadiusValue.textContent = "0";
            cardShadowInput.value = "10";
            cardShadowValue.textContent = "10";
            break;
          case "cool":
            // 冷色调
            bgColor1Input.value = "#4B0082";
            bgColor1Value.textContent = "#4B0082";
            bgColor2Input.value = "#9370DB";
            bgColor2Value.textContent = "#9370DB";
            gradientTypeSelect.value = "to bottom";
            cardRadiusInput.value = "0";
            cardRadiusValue.textContent = "0";
            cardShadowInput.value = "7";
            cardShadowValue.textContent = "7";
            break;
          case "custom":
            // 自定义样式，不做任何改变
            break;
          case "default":
          default:
            // 默认样式
            bgColor1Input.value = "#D5E7FB";
            bgColor1Value.textContent = "#D5E7FB";
            bgColor2Input.value = "#9EBEFA";
            bgColor2Value.textContent = "#9EBEFA";
            gradientTypeSelect.value = "to right";
            cardRadiusInput.value = "0";
            cardRadiusValue.textContent = "0";
            cardShadowInput.value = "5";
            cardShadowValue.textContent = "5";
            break;
        }
      });

      // 绘制水印
      function drawWatermark() {
        const watermarkText =
          watermarkTextInput.value.trim() || "公众号:科技研习室";
        const watermarkColor = watermarkColorInput.value;
        const watermarkOpacity = parseInt(watermarkOpacityInput.value) / 100;
        const watermarkSize = parseInt(watermarkSizeInput.value);
        const watermarkPosition = watermarkPositionSelect.value;

        // 保存当前上下文状态
        ctx.save();

        // 设置水印样式
        ctx.font = `${watermarkSize}px Arial`;
        ctx.fillStyle = hexToRgba(watermarkColor, watermarkOpacity);

        // 计算水印位置，确保不会覆盖二维码
        let x, y;
        const padding = 20; // 边缘内边距
        const textWidth = ctx.measureText(watermarkText).width;
        const textHeight = watermarkSize;

        // 根据选择的位置确定坐标
        switch (watermarkPosition) {
          case "bottom-right":
            // 始终将水印放在右下角
            x = canvas.width - textWidth - padding;
            y = canvas.height - padding;
            break;
          case "bottom-left":
            x = padding;
            y = canvas.height - padding;
            break;
          case "top-right":
            x = canvas.width - textWidth - padding;
            y = padding + textHeight;
            break;
          case "top-left":
            x = padding;
            y = padding + textHeight;
            break;
          case "center":
            x = (canvas.width - textWidth) / 2;
            y = (canvas.height + textHeight) / 2;
            break;
          default:
            x = padding;
            y = canvas.height - padding;
        }

        // 设置文本基线
        ctx.textBaseline = "bottom";

        // 绘制水印
        ctx.fillText(watermarkText, x, y);

        // 恢复上下文状态
        ctx.restore();
      }

      // 将十六进制颜色转换为带透明度的rgba
      function hexToRgba(hex, alpha) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
      }

      // 页面加载完成后初始化
      document.addEventListener('DOMContentLoaded', function() {
        // 触发样式预设的change事件，应用随机样式
        const event = new Event('change');
        stylePresetSelect.dispatchEvent(event);
        // 页面加载时调用resetForm，确保图片预览隐藏
        resetForm();
      });
      
      // 重置表单
      function resetForm() {
        // 重置文件输入
        mainImageUploadInput.value = "";
        qrCodeImageUploadInput.value = "";
        mainImageFiles = [];
        qrCodeImageFiles = [];
        mainImagePreviewContainer.innerHTML = "";
        qrCodeImagePreviewContainer.innerHTML = "";

        // 重置其他输入字段
        cardTitleInput.value = "";
        fontFamilySelect.value = "Arial";
        textColorInput.value = "#000000";
        textColorValue.textContent = "#000000";
        textSizeInput.value = "24";
        textSizeValue.textContent = "24";
        textShadowInput.value = "0";
        textShadowValue.textContent = "0";
        stylePresetSelect.value = "random";
        
        // 重新生成随机样式
        const randomColors = generateRandomGradientColors();
        bgColor1Input.value = randomColors.primary;
        bgColor1Value.textContent = randomColors.primary;
        bgColor2Input.value = randomColors.secondary;
        bgColor2Value.textContent = randomColors.secondary;
        const directions = ["to right", "to bottom", "to right bottom", "to left bottom"];
        gradientTypeSelect.value = directions[Math.floor(Math.random() * directions.length)];
        cardRadiusInput.value = Math.floor(Math.random() * 16).toString();
        cardShadowInput.value = (3 + Math.floor(Math.random() * 8)).toString();

        // 重置水印设置
        enableWatermarkInput.checked = true;
        watermarkTextInput.value = "公众号:科技研习室";
        watermarkColorInput.value = "#000000";
        watermarkColorValue.textContent = "#000000";
        watermarkOpacityInput.value = "30";
        watermarkOpacityValue.textContent = "30";
        watermarkSizeInput.value = "16";
        watermarkSizeValue.textContent = "16";
        watermarkPositionSelect.value = "bottom-right";

        // 重置预览
        cardPreviewContainer.innerHTML = "";
        downloadBtn.disabled = true;

        // 隐藏消息
        toastDiv.classList.remove("show");

        showMessage("已重置所有设置", "success");
      }

      // 模态框逻辑
      const modal = document.getElementById("imageModal");
      const modalImg = document.getElementById("modalImage");
      const closeBtn = document.querySelector(".close-btn");

      function openModal(src) {
        modal.style.display = "block";
        modalImg.src = src;
      }

      closeBtn.onclick = function() {
        modal.style.display = "none";
      }

      window.onclick = function(event) {
        if (event.target == modal) {
          modal.style.display = "none";
        }
      }
    </script>
  </body>
</html>
